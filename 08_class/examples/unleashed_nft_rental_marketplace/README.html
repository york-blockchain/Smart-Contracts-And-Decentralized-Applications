<!DOCTYPE html><html><head>
      <title>README</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////Users/dhruvin/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.6.3/node_modules/@shd101wyy/mume/dependencies/katex/katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <h1 class="mume-header" id="web3-unleashed-build-a-nft-rental-marketplace-part-1">Web3 Unleashed: Build a NFT Rental Marketplace Part 1</h1>

<h2 class="mume-header" id="overview">Overview</h2>

<p>In episode 2, we covered rentable NFTs (see the tutorial <a href="https://trufflesuite.com/guides/rentable-nft/">here</a>). Please go over this beforehand for an explanation of that code.</p>
<p>In this guide, we&apos;ll create a rental marketplace that will allow users to list and rent rentable NFTs! Specifically, we&apos;ll cover:</p>
<ol>
<li>Starting a project using the Truffle React box to prepare for building a frontend in part 2</li>
<li>Writing a rental marketplace contract that will interact with rentable NFTs</li>
<li>Deploying contracts that are dependent on each other</li>
<li>Writing tests</li>
<li>Verifying the <code>RentablePets</code> contract using <a href="https://github.com/rkalis/truffle-plugin-verify">truffle-plugin-verify</a> on Goerli Etherscan</li>
<li>Using Ganache forking and unlocking your MetaMask account locally to test the marketplace contract with already deployed contracts</li>
<li>Writing Truffle scripts for fast testing</li>
</ol>
<h2 class="mume-header" id="download-system-requirements">Download System Requirements</h2>

<p>You&apos;ll need to install:</p>
<ul>
<li><a href="https://nodejs.org/en/">Node.js</a>, v12 or higher</li>
<li><a href="https://trufflesuite.com/docs/truffle/getting-started/installation/?utm_source=blog&amp;utm_medium=post&amp;utm_campaign=2022_May_truffle-blog-nft-marketplace_acquisition_content">truffle</a></li>
<li><a href="https://github.com/trufflesuite/ganache">ganache CLI</a></li>
</ul>
<h2 class="mume-header" id="create-an-infura-account-and-project">Create an Infura account and project</h2>

<p>To connect your DApp to Ethereum mainnet and testnets, you&apos;ll need an Infura account. Sign up for an account <a href="https://infura.io/register?utm_source=truffle&amp;utm_medium=webinar&amp;utm_campaign=2022_Aug_unleashed-rentable-nft_tutorial_content">here</a>.</p>
<p>Once you&apos;re signed in, create a project! Let&apos;s call it <code>rentable-nft</code>, and select Web3 API from the dropdown</p>
<h2 class="mume-header" id="register-for-a-metamask-wallet">Register for a MetaMask wallet</h2>

<p>To interact with your DApp in the browser, you&apos;ll need a MetaMask wallet. You can download it and create one <a href="https://metamask.io/download/?utm_source=truffle&amp;utm_medium=webinar&amp;utm_campaign=2022_Aug_unleashed-rentable-nft_tutorial_content">here</a>.</p>
<h2 class="mume-header" id="download-vs-code">Download VS Code</h2>

<p>Feel free to use whatever IDE you want, but we highly recommend using VS Code! You can run through most of this tutorial using the Truffle extension to create, build, and deploy your smart contracts, all without using the CLI! You can read more about it <a href="https://trufflesuite.com/blog/build-on-web3-with-truffle-vs-code-extension/">here</a>.</p>
<h2 class="mume-header" id="get-some-test-eth">Get Some Test Eth</h2>

<p>In order to deploy to the public testnets, you&apos;ll need some test Eth to cover your gas fees! <a href="https://faucet.paradigm.xyz/">Paradigm</a> has a great MultiFaucet that deposits funds across 8 different networks all at once.</p>
<h2 class="mume-header" id="set-up-your-project">Set Up Your Project</h2>

<p>Since the end goal is a full stack rental marketplace, we&apos;ll be starting with <a href="https://github.com/truffle-box/react-box">Truffle&apos;s React Box</a>!</p>
<pre data-role="codeBlock" data-info="shell" class="language-shell">truffle unbox react rental_marketplace
<span class="token builtin class-name">cd</span> rental_marketplace
</pre><p>Your file structure should look something like this:</p>
<pre data-role="codeBlock" data-info="shell" class="language-shell">&#x251C;&#x2500;&#x2500; LICENSE
&#x251C;&#x2500;&#x2500; README.md
&#x251C;&#x2500;&#x2500; client
&#x2502;   &#x251C;&#x2500;&#x2500; README.md
&#x2502;   &#x251C;&#x2500;&#x2500; node_modules
&#x2502;   &#x251C;&#x2500;&#x2500; package-lock.json
&#x2502;   &#x251C;&#x2500;&#x2500; package.json
&#x2502;   &#x251C;&#x2500;&#x2500; public
&#x2502;   &#x2514;&#x2500;&#x2500; src
&#x2514;&#x2500;&#x2500; truffle
    &#x251C;&#x2500;&#x2500; contracts
    &#x251C;&#x2500;&#x2500; migrations
    &#x251C;&#x2500;&#x2500; package-lock.json
    &#x251C;&#x2500;&#x2500; package.json
    &#x251C;&#x2500;&#x2500; scripts
    &#x251C;&#x2500;&#x2500; <span class="token builtin class-name">test</span>
    &#x2514;&#x2500;&#x2500; truffle-config.js
</pre><p>We&apos;ll only be working with contracts, so hop into the <code>truffle</code> directory. We&apos;ll also be using OpenZeppelin&apos;s base contracts and test helpers, so let&apos;s install that now too.</p>
<pre data-role="codeBlock" data-info="shell" class="language-shell"><span class="token builtin class-name">cd</span> truffle
<span class="token function">npm</span> i @openzeppelin/contracts
<span class="token function">npm</span> i -D @openzeppelin/test-helpers
</pre><h2 class="mume-header" id="copy-over-the-rentable-nft-contracts">Copy over the rentable NFT Contracts</h2>

<p>Our marketplace will only allow NFTs that fulfill the ERC4907 standard to be listed, so we will also provide users a way to mint their own rentable NFTs. To do so, copy over the contracts we created in the second episode of Web3 Unleashed and delete the existing <code>SimpleStorage</code> contract from the box:</p>
<ul>
<li><a href="https://github.com/trufflesuite/unleashed_rentable_nft/blob/main/contracts/IERC4907.sol"><code>IERC4907</code></a></li>
<li><a href="https://github.com/trufflesuite/unleashed_rentable_nft/blob/main/contracts/ERC4907.sol"><code>ERC4907</code></a></li>
<li><a href="https://github.com/trufflesuite/unleashed_rentable_nft/blob/main/contracts/RentablePets.sol"><code>RentablePets</code></a></li>
</ul>
<p>Also copy:</p>
<ul>
<li><a href="https://github.com/trufflesuite/unleashed_rentable_nft/blob/main/test/test_rentable_pets.js"><code>test_rentable_pets.js</code></a></li>
<li><a href="https://github.com/trufflesuite/unleashed_rentable_nft/blob/main/migrations/1_deploy_contracts.js"><code>1_deploy_contracts.js</code></a></li>
</ul>
<p>Also, since we are providing a generic rentable NFT for users to mint, let&apos;s rename <code>RentablePets.sol</code> to <code>RentableNft.sol</code>, and change all occurrences of <code>RentablePets</code> to <code>RentableNft</code> in the contract, migration, and test!</p>
<p>Your file structure should look like this:</p>
<pre data-role="codeBlock" data-info="shell" class="language-shell">&#x251C;&#x2500;&#x2500; contracts
&#x2502;   &#x251C;&#x2500;&#x2500; ERC4907.sol
&#x2502;   &#x251C;&#x2500;&#x2500; IERC4907.sol
&#x2502;   &#x2514;&#x2500;&#x2500; RentableNft.sol
&#x251C;&#x2500;&#x2500; migrations
&#x2502;   &#x2514;&#x2500;&#x2500; 1_deploy_simple_storage.js
&#x251C;&#x2500;&#x2500; package-lock.json
&#x251C;&#x2500;&#x2500; package.json
&#x251C;&#x2500;&#x2500; scripts
&#x2502;   &#x2514;&#x2500;&#x2500; increment.js
&#x251C;&#x2500;&#x2500; <span class="token builtin class-name">test</span>
&#x2502;   &#x2514;&#x2500;&#x2500; test_rentable_nft.js
&#x2514;&#x2500;&#x2500; truffle-config.js
</pre><p>Quickly run a <code>truffle test</code> to see if everything was set up correctly.</p>
<h2 class="mume-header" id="write-the-marketplace-smart-contract">Write the Marketplace Smart Contract</h2>

<p>With that out of the way, let&apos;s get started on our marketplace smart contract! Create a new contract called <code>Marketplace.sol</code>:</p>
<pre data-role="codeBlock" data-info="shell" class="language-shell">truffle create contract Marketplace
</pre><p>This contract will be long! It&apos;s completed form will look like this:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token comment">// SPDX-License-Identifier: MIT</span>
pragma solidity <span class="token operator">&gt;=</span><span class="token number">0.4</span><span class="token number">.22</span> <span class="token operator">&lt;</span><span class="token number">0.9</span><span class="token number">.0</span><span class="token punctuation">;</span>

<span class="token keyword module keyword-import">import</span> <span class="token string">&quot;@openzeppelin/contracts/utils/structs/EnumerableSet.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword module keyword-import">import</span> <span class="token string">&quot;@openzeppelin/contracts/utils/Counters.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword module keyword-import">import</span> <span class="token string">&quot;@openzeppelin/contracts/interfaces/IERC165.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword module keyword-import">import</span> <span class="token string">&quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword module keyword-import">import</span> <span class="token string">&quot;@openzeppelin/contracts/interfaces/IERC721.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword module keyword-import">import</span> <span class="token string">&quot;./IERC4907.sol&quot;</span><span class="token punctuation">;</span>

contract <span class="token maybe-class-name">Marketplace</span> is <span class="token maybe-class-name">ReentrancyGuard</span> <span class="token punctuation">{</span>
    using <span class="token maybe-class-name">Counters</span> <span class="token keyword control-flow keyword-for">for</span> <span class="token maybe-class-name">Counters</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">;</span>
    using <span class="token maybe-class-name">EnumerableSet</span> <span class="token keyword control-flow keyword-for">for</span> <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">AddressSet</span></span><span class="token punctuation">;</span>
    using <span class="token maybe-class-name">EnumerableSet</span> <span class="token keyword control-flow keyword-for">for</span> <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">UintSet</span></span><span class="token punctuation">;</span>
    <span class="token maybe-class-name">Counters</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Counter</span></span> <span class="token keyword keyword-private">private</span> _nftsListed<span class="token punctuation">;</span>
    address <span class="token keyword keyword-private">private</span> _marketOwner<span class="token punctuation">;</span>
    uint256 <span class="token keyword keyword-private">private</span> _listingFee <span class="token operator">=</span> <span class="token number">.001</span> ether<span class="token punctuation">;</span>
    <span class="token comment">// maps contract address to token id to properties of the rental listing</span>
    <span class="token function">mapping</span><span class="token punctuation">(</span><span class="token parameter">address</span> <span class="token arrow operator">=&gt;</span> <span class="token function">mapping</span><span class="token punctuation">(</span><span class="token parameter">uint256</span> <span class="token arrow operator">=&gt;</span> <span class="token maybe-class-name">Listing</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-private">private</span> _listingMap<span class="token punctuation">;</span>
    <span class="token comment">// maps nft contracts to set of the tokens that are listed</span>
    <span class="token function">mapping</span><span class="token punctuation">(</span><span class="token parameter">address</span> <span class="token arrow operator">=&gt;</span> <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">UintSet</span></span><span class="token punctuation">)</span> <span class="token keyword keyword-private">private</span> _nftContractTokensMap<span class="token punctuation">;</span>
    <span class="token comment">// tracks the nft contracts that have been listed</span>
    <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">AddressSet</span></span> <span class="token keyword keyword-private">private</span> _nftContracts<span class="token punctuation">;</span>
    struct <span class="token maybe-class-name">Listing</span> <span class="token punctuation">{</span>
        address owner<span class="token punctuation">;</span>
        address user<span class="token punctuation">;</span>
        address nftContract<span class="token punctuation">;</span>
        uint256 tokenId<span class="token punctuation">;</span>
        uint256 pricePerDay<span class="token punctuation">;</span>
        uint256 startDateUNIX<span class="token punctuation">;</span> <span class="token comment">// when the nft can start being rented</span>
        uint256 endDateUNIX<span class="token punctuation">;</span> <span class="token comment">// when the nft can no longer be rented</span>
        uint256 expires<span class="token punctuation">;</span> <span class="token comment">// when the user can no longer rent it</span>
    <span class="token punctuation">}</span>
    event <span class="token function"><span class="token maybe-class-name">NFTListed</span></span><span class="token punctuation">(</span>
        address owner<span class="token punctuation">,</span>
        address user<span class="token punctuation">,</span>
        address nftContract<span class="token punctuation">,</span>
        uint256 tokenId<span class="token punctuation">,</span>
        uint256 pricePerDay<span class="token punctuation">,</span>
        uint256 startDateUNIX<span class="token punctuation">,</span>
        uint256 endDateUNIX<span class="token punctuation">,</span>
        uint256 expires
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    event <span class="token function"><span class="token maybe-class-name">NFTRented</span></span><span class="token punctuation">(</span>
        address owner<span class="token punctuation">,</span>
        address user<span class="token punctuation">,</span>
        address nftContract<span class="token punctuation">,</span>
        uint256 tokenId<span class="token punctuation">,</span>
        uint256 startDateUNIX<span class="token punctuation">,</span>
        uint256 endDateUNIX<span class="token punctuation">,</span>
        uint64 expires<span class="token punctuation">,</span>
        uint256 rentalFee
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    event <span class="token function"><span class="token maybe-class-name">NFTUnlisted</span></span><span class="token punctuation">(</span>
        address unlistSender<span class="token punctuation">,</span>
        address nftContract<span class="token punctuation">,</span>
        uint256 tokenId<span class="token punctuation">,</span>
        uint256 refund
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _marketOwner <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token property-access">sender</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// function to list NFT for rental</span>
    <span class="token keyword keyword-function">function</span> <span class="token function">listNFT</span><span class="token punctuation">(</span>
        <span class="token parameter">address nftContract<span class="token punctuation">,</span>
        uint256 tokenId<span class="token punctuation">,</span>
        uint256 pricePerDay<span class="token punctuation">,</span>
        uint256 startDateUNIX<span class="token punctuation">,</span>
        uint256 endDateUNIX</span>
    <span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> payable nonReentrant <span class="token punctuation">{</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token function">isRentableNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Contract is not an ERC4907&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token constant">IERC721</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">ownerOf</span><span class="token punctuation">(</span>tokenId<span class="token punctuation">)</span> <span class="token operator">==</span> msg<span class="token punctuation">.</span><span class="token property-access">sender</span><span class="token punctuation">,</span> <span class="token string">&quot;Not owner of nft&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">==</span> _listingFee<span class="token punctuation">,</span> <span class="token string">&quot;Not enough ether for listing fee&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>pricePerDay <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;Rental price should be greater than 0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>startDateUNIX <span class="token operator">&gt;=</span> block<span class="token punctuation">.</span><span class="token property-access">timestamp</span><span class="token punctuation">,</span> <span class="token string">&quot;Start date cannot be in the past&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>endDateUNIX <span class="token operator">&gt;=</span> startDateUNIX<span class="token punctuation">,</span> <span class="token string">&quot;End date cannot be before the start date&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>_listingMap<span class="token punctuation">[</span>nftContract<span class="token punctuation">]</span><span class="token punctuation">[</span>tokenId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">nftContract</span> <span class="token operator">==</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;This NFT has already been listed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token function">payable</span><span class="token punctuation">(</span>_marketOwner<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">transfer</span><span class="token punctuation">(</span>_listingFee<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _listingMap<span class="token punctuation">[</span>nftContract<span class="token punctuation">]</span><span class="token punctuation">[</span>tokenId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function"><span class="token maybe-class-name">Listing</span></span><span class="token punctuation">(</span>
            msg<span class="token punctuation">.</span><span class="token property-access">sender</span><span class="token punctuation">,</span>
            <span class="token function">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nftContract<span class="token punctuation">,</span>
            tokenId<span class="token punctuation">,</span>
            pricePerDay<span class="token punctuation">,</span>
            startDateUNIX<span class="token punctuation">,</span>
            endDateUNIX<span class="token punctuation">,</span>
            <span class="token number">0</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        _nftsListed<span class="token punctuation">.</span><span class="token method function property-access">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span>_nftContractTokensMap<span class="token punctuation">[</span>nftContract<span class="token punctuation">]</span><span class="token punctuation">,</span> tokenId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span>_nftContracts<span class="token punctuation">,</span> nftContract<span class="token punctuation">)</span><span class="token punctuation">;</span>
        emit <span class="token function"><span class="token maybe-class-name">NFTListed</span></span><span class="token punctuation">(</span>
            <span class="token constant">IERC721</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">ownerOf</span><span class="token punctuation">(</span>tokenId<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nftContract<span class="token punctuation">,</span>
            tokenId<span class="token punctuation">,</span>
            pricePerDay<span class="token punctuation">,</span>
            startDateUNIX<span class="token punctuation">,</span>
            endDateUNIX<span class="token punctuation">,</span>
            <span class="token number">0</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// function to rent NFT</span>
    <span class="token keyword keyword-function">function</span> <span class="token function">rentNFT</span><span class="token punctuation">(</span>
        <span class="token parameter">address nftContract<span class="token punctuation">,</span>
        uint256 tokenId<span class="token punctuation">,</span>
        uint64 expires</span>
    <span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> payable nonReentrant <span class="token punctuation">{</span>
        <span class="token maybe-class-name">Listing</span> storage listing <span class="token operator">=</span> _listingMap<span class="token punctuation">[</span>nftContract<span class="token punctuation">]</span><span class="token punctuation">[</span>tokenId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span><span class="token property-access">user</span> <span class="token operator">==</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> block<span class="token punctuation">.</span><span class="token property-access">timestamp</span> <span class="token operator">&gt;</span> listing<span class="token punctuation">.</span><span class="token property-access">expires</span><span class="token punctuation">,</span> <span class="token string">&quot;NFT already rented&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>expires <span class="token operator">&lt;=</span> listing<span class="token punctuation">.</span><span class="token property-access">endDateUNIX</span><span class="token punctuation">,</span> <span class="token string">&quot;Rental period exceeds max date rentable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Transfer rental fee</span>
        uint256 numDays <span class="token operator">=</span> <span class="token punctuation">(</span>expires <span class="token operator">-</span> block<span class="token punctuation">.</span><span class="token property-access">timestamp</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">60</span><span class="token operator">/</span><span class="token number">60</span><span class="token operator">/</span><span class="token number">24</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        uint256 rentalFee <span class="token operator">=</span> listing<span class="token punctuation">.</span><span class="token property-access">pricePerDay</span> <span class="token operator">*</span> numDays<span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">&gt;=</span> rentalFee<span class="token punctuation">,</span> <span class="token string">&quot;Not enough ether to cover rental period&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">payable</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span><span class="token property-access">owner</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">transfer</span><span class="token punctuation">(</span>rentalFee<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Update listing</span>
        <span class="token constant">IERC4907</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">setUser</span><span class="token punctuation">(</span>tokenId<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token property-access">sender</span><span class="token punctuation">,</span> expires<span class="token punctuation">)</span><span class="token punctuation">;</span>
        listing<span class="token punctuation">.</span><span class="token property-access">user</span> <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token property-access">sender</span><span class="token punctuation">;</span>
        listing<span class="token punctuation">.</span><span class="token property-access">expires</span> <span class="token operator">=</span> expires<span class="token punctuation">;</span>

        emit <span class="token function"><span class="token maybe-class-name">NFTRented</span></span><span class="token punctuation">(</span>
            <span class="token constant">IERC721</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">ownerOf</span><span class="token punctuation">(</span>tokenId<span class="token punctuation">)</span><span class="token punctuation">,</span>
            msg<span class="token punctuation">.</span><span class="token property-access">sender</span><span class="token punctuation">,</span>
            nftContract<span class="token punctuation">,</span>
            tokenId<span class="token punctuation">,</span>
            listing<span class="token punctuation">.</span><span class="token property-access">startDateUNIX</span><span class="token punctuation">,</span>
            listing<span class="token punctuation">.</span><span class="token property-access">endDateUNIX</span><span class="token punctuation">,</span>
            expires<span class="token punctuation">,</span>
            rentalFee
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// function to unlist your rental, refunding the user for any lost time</span>
    <span class="token keyword keyword-function">function</span> <span class="token function">unlistNFT</span><span class="token punctuation">(</span><span class="token parameter">address nftContract<span class="token punctuation">,</span> uint256 tokenId</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> payable nonReentrant <span class="token punctuation">{</span>
        <span class="token maybe-class-name">Listing</span> storage listing <span class="token operator">=</span> _listingMap<span class="token punctuation">[</span>nftContract<span class="token punctuation">]</span><span class="token punctuation">[</span>tokenId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span><span class="token property-access">owner</span> <span class="token operator">!=</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;This NFT is not listed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span><span class="token property-access">owner</span> <span class="token operator">==</span> msg<span class="token punctuation">.</span><span class="token property-access">sender</span> <span class="token operator">||</span> _marketOwner <span class="token operator">==</span> msg<span class="token punctuation">.</span><span class="token property-access">sender</span> <span class="token punctuation">,</span> <span class="token string">&quot;Not approved to unlist NFT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// fee to be returned to user if unlisted before rental period is up</span>
        <span class="token comment">// nothing to refund if no renter</span>
        uint256 refund <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword control-flow keyword-if">if</span> <span class="token punctuation">(</span>listing<span class="token punctuation">.</span><span class="token property-access">user</span> <span class="token operator">!=</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            refund <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span><span class="token property-access">expires</span> <span class="token operator">-</span> block<span class="token punctuation">.</span><span class="token property-access">timestamp</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">60</span> <span class="token operator">/</span> <span class="token number">60</span> <span class="token operator">/</span> <span class="token number">24</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> listing<span class="token punctuation">.</span><span class="token property-access">pricePerDay</span><span class="token punctuation">;</span>
            <span class="token function">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">&gt;=</span> refund<span class="token punctuation">,</span> <span class="token string">&quot;Not enough ether to cover refund&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">payable</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">transfer</span><span class="token punctuation">(</span>refund<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// clean up data</span>
        <span class="token constant">IERC4907</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">setUser</span><span class="token punctuation">(</span>tokenId<span class="token punctuation">,</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token method function property-access">remove</span><span class="token punctuation">(</span>_nftContractTokensMap<span class="token punctuation">[</span>nftContract<span class="token punctuation">]</span><span class="token punctuation">,</span> tokenId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-delete">delete</span> _listingMap<span class="token punctuation">[</span>nftContract<span class="token punctuation">]</span><span class="token punctuation">[</span>tokenId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword control-flow keyword-if">if</span> <span class="token punctuation">(</span><span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token method function property-access">length</span><span class="token punctuation">(</span>_nftContractTokensMap<span class="token punctuation">[</span>nftContract<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token method function property-access">remove</span><span class="token punctuation">(</span>_nftContracts<span class="token punctuation">,</span> nftContract<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        _nftsListed<span class="token punctuation">.</span><span class="token method function property-access">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        emit <span class="token function"><span class="token maybe-class-name">NFTUnlisted</span></span><span class="token punctuation">(</span>
            msg<span class="token punctuation">.</span><span class="token property-access">sender</span><span class="token punctuation">,</span>
            nftContract<span class="token punctuation">,</span>
            tokenId<span class="token punctuation">,</span>
            refund
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 
     * function to get all listings
     *
     * WARNING: This operation will copy the entire storage to memory, which can be quite expensive. This is designed
     * to mostly be used by view accessors that are queried without any gas fees. Developers should keep in mind that
     * this function has an unbounded cost, and using it as part of a state-changing function may render the function
     * uncallable if the set grows to a point where copying to memory consumes too much gas to fit in a block.
     */</span>
    <span class="token keyword keyword-function">function</span> <span class="token function">getAllListings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token maybe-class-name">Listing</span><span class="token punctuation">[</span><span class="token punctuation">]</span> memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token maybe-class-name">Listing</span><span class="token punctuation">[</span><span class="token punctuation">]</span> memory listings <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Listing</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>_nftsListed<span class="token punctuation">.</span><span class="token method function property-access">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        uint256 listingsIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        address<span class="token punctuation">[</span><span class="token punctuation">]</span> memory nftContracts <span class="token operator">=</span> <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token method function property-access">values</span><span class="token punctuation">(</span>_nftContracts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword control-flow keyword-for">for</span> <span class="token punctuation">(</span>uint i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nftContracts<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            address nftAddress <span class="token operator">=</span> nftContracts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            uint256<span class="token punctuation">[</span><span class="token punctuation">]</span> memory tokens <span class="token operator">=</span> <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token method function property-access">values</span><span class="token punctuation">(</span>_nftContractTokensMap<span class="token punctuation">[</span>nftAddress<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword control-flow keyword-for">for</span> <span class="token punctuation">(</span>uint j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> tokens<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                listings<span class="token punctuation">[</span>listingsIndex<span class="token punctuation">]</span> <span class="token operator">=</span> _listingMap<span class="token punctuation">[</span>nftAddress<span class="token punctuation">]</span><span class="token punctuation">[</span>tokens<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                listingsIndex<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword control-flow keyword-return">return</span> listings<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-function">function</span> <span class="token function">getListingFee</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow keyword-return">return</span> _listingFee<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-function">function</span> <span class="token function">isRentableNFT</span><span class="token punctuation">(</span><span class="token parameter">address nftContract</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bool _isRentable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        bool _isNFT <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword control-flow keyword-try">try</span> <span class="token constant">IERC165</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">supportsInterface</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token constant">IERC4907</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">interfaceId</span><span class="token punctuation">)</span> <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">bool rentable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            _isRentable <span class="token operator">=</span> rentable<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword control-flow keyword-catch">catch</span> <span class="token punctuation">{</span>
            <span class="token keyword control-flow keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword control-flow keyword-try">try</span> <span class="token constant">IERC165</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">supportsInterface</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token constant">IERC721</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">interfaceId</span><span class="token punctuation">)</span> <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">bool nft</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            _isNFT <span class="token operator">=</span> nft<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword control-flow keyword-catch">catch</span> <span class="token punctuation">{</span>
            <span class="token keyword control-flow keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword control-flow keyword-return">return</span> _isRentable <span class="token operator">&amp;&amp;</span> _isNFT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>Let&apos;s walk through the code piece by piece!</p>
<h3 class="mume-header" id="imports">Imports</h3>

<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token keyword module keyword-import">import</span> <span class="token string">&quot;@openzeppelin/contracts/utils/structs/EnumerableSet.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword module keyword-import">import</span> <span class="token string">&quot;@openzeppelin/contracts/utils/Counters.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword module keyword-import">import</span> <span class="token string">&quot;@openzeppelin/contracts/interfaces/IERC165.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword module keyword-import">import</span> <span class="token string">&quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword module keyword-import">import</span> <span class="token string">&quot;@openzeppelin/contracts/interfaces/IERC721.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword module keyword-import">import</span> <span class="token string">&quot;./IERC4907.sol&quot;</span><span class="token punctuation">;</span>
</pre><p>If you followed our <a href="https://trufflesuite.com/guides/rentable-nft/">guide in episode 2</a>, you should be familiar with the <code>Counters</code>, <code>IERC165</code>, <code>IERC721</code>, and <code>IERC4907</code>, and <code>Counters</code> contracts. We&apos;re using two new ones here:</p>
<ul>
<li><a href="https://docs.openzeppelin.com/contracts/3.x/api/utils#EnumerableSet"><code>EnumerableSet</code></a> is a nifty utility contract that will help us with storing our rental listings</li>
<li><a href="https://docs.openzeppelin.com/contracts/4.x/api/security#ReentrancyGuard"><code>ReentrancyGuard</code></a> is a contract we can inherit to protect our contract from <a href="https://hackernoon.com/hack-solidity-reentrancy-attack">reentrancy attacks</a> since we will be transferring ETHer between accounts</li>
</ul>
<p>In order to use <code>ReentrancyGuard</code>, we want <code>Marketplace</code> to inherit <code>ReentrancyGuard</code>:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript">contract <span class="token maybe-class-name">Marketplace</span> is <span class="token maybe-class-name">ReentrancyGuard</span> <span class="token punctuation">{</span>
</pre><h3 class="mume-header" id="contract-variables">Contract Variables</h3>

<pre data-role="codeBlock" data-info="javascript" class="language-javascript">using <span class="token maybe-class-name">Counters</span> <span class="token keyword control-flow keyword-for">for</span> <span class="token maybe-class-name">Counters</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">;</span>
using <span class="token maybe-class-name">EnumerableSet</span> <span class="token keyword control-flow keyword-for">for</span> <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">AddressSet</span></span><span class="token punctuation">;</span>
using <span class="token maybe-class-name">EnumerableSet</span> <span class="token keyword control-flow keyword-for">for</span> <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">UintSet</span></span><span class="token punctuation">;</span>
</pre><p>This is just syntactic sugar for using these contracts. You can read more about it <a href="https://docs.soliditylang.org/en/v0.8.14/contracts.html#using-for">here</a>.</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript">address <span class="token keyword keyword-private">private</span> _marketOwner<span class="token punctuation">;</span>
uint256 <span class="token keyword keyword-private">private</span> _listingFee <span class="token operator">=</span> <span class="token number">.001</span> ether<span class="token punctuation">;</span>
</pre><p>In our marketplace, we want to pass a listing fee to the owner of the marketplace contract any time a NFT rental is listed.</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token maybe-class-name">Counters</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Counter</span></span> <span class="token keyword keyword-private">private</span> _nftsListed<span class="token punctuation">;</span>
<span class="token comment">// maps contract address to token id to properties of the rental listing</span>
<span class="token function">mapping</span><span class="token punctuation">(</span><span class="token parameter">address</span> <span class="token arrow operator">=&gt;</span> <span class="token function">mapping</span><span class="token punctuation">(</span><span class="token parameter">uint256</span> <span class="token arrow operator">=&gt;</span> <span class="token maybe-class-name">Listing</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-private">private</span> _listingMap<span class="token punctuation">;</span>
<span class="token comment">// maps nft contracts to set of the tokens that are listed</span>
<span class="token function">mapping</span><span class="token punctuation">(</span><span class="token parameter">address</span> <span class="token arrow operator">=&gt;</span> <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">UintSet</span></span><span class="token punctuation">)</span> <span class="token keyword keyword-private">private</span> _nftContractTokensMap<span class="token punctuation">;</span>
<span class="token comment">// tracks the nft contracts that have been listed</span>
<span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">AddressSet</span></span> <span class="token keyword keyword-private">private</span> _nftContracts<span class="token punctuation">;</span>
</pre><p>This next set of code is for how we are storing the listing data. Solidity doesn&apos;t allow for map iterability, so we have to do some creative workarounds here. Namely, we store the keys we would iterate over in OpenZeppelin&apos;s <code>EnumerableSet</code>. How it is used will become more obvious when we go over <code>getAllListings</code>.</p>
<ul>
<li><code>_nftsListed</code> simply tracks how many nfts are currently listed.</li>
<li><code>_listingMap</code> is a map of maps that will give us listing information for a specific tokenId in an NFT contract.</li>
<li><code>_nftContractTokensMap</code> will tell us all the tokenIds listed from a particular NFT contract.</li>
<li><code>_nftContracts</code> is a set of all the NFT contracts that have been listed.</li>
</ul>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript">struct <span class="token maybe-class-name">Listing</span> <span class="token punctuation">{</span>
    address owner<span class="token punctuation">;</span>
    address user<span class="token punctuation">;</span>
    address nftContract<span class="token punctuation">;</span>
    uint256 tokenId<span class="token punctuation">;</span>
    uint256 pricePerDay<span class="token punctuation">;</span>
    uint256 startDateUNIX<span class="token punctuation">;</span> <span class="token comment">// when the nft can start being rented</span>
    uint256 endDateUNIX<span class="token punctuation">;</span> <span class="token comment">// when the nft can no longer be rented</span>
    uint256 expires<span class="token punctuation">;</span> <span class="token comment">// when the user can no longer rent it</span>
<span class="token punctuation">}</span>
event <span class="token function"><span class="token maybe-class-name">NFTListed</span></span><span class="token punctuation">(</span>
    address owner<span class="token punctuation">,</span>
    address user<span class="token punctuation">,</span>
    address nftContract<span class="token punctuation">,</span>
    uint256 tokenId<span class="token punctuation">,</span>
    uint256 pricePerDay<span class="token punctuation">,</span>
    uint256 startDateUNIX<span class="token punctuation">,</span>
    uint256 endDateUNIX<span class="token punctuation">,</span>
    uint256 expires
<span class="token punctuation">)</span><span class="token punctuation">;</span>
event <span class="token function"><span class="token maybe-class-name">NFTRented</span></span><span class="token punctuation">(</span>
    address owner<span class="token punctuation">,</span>
    address user<span class="token punctuation">,</span>
    address nftContract<span class="token punctuation">,</span>
    uint256 tokenId<span class="token punctuation">,</span>
    uint256 startDateUNIX<span class="token punctuation">,</span>
    uint256 endDateUNIX<span class="token punctuation">,</span>
    uint64 expires<span class="token punctuation">,</span>
    uint256 rentalFee
<span class="token punctuation">)</span><span class="token punctuation">;</span>
event <span class="token function"><span class="token maybe-class-name">NFTUnlisted</span></span><span class="token punctuation">(</span>
    address unlistSender<span class="token punctuation">,</span>
    address nftContract<span class="token punctuation">,</span>
    uint256 tokenId<span class="token punctuation">,</span>
    uint256 refund
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>These last variables are just the data we want to store and emit about a particular listing. Specifically:</p>
<ul>
<li><code>owner</code> is the address of the token owner</li>
<li><code>user</code> is the address of the <code>user</code> (i.e., renter). If there is none, it is the zero address</li>
<li><code>nftContract</code> is the NFT contract address (i.e., the NFT collection)</li>
<li><code>tokenId</code> is the tokenId of the listed NFT within the NFT collection</li>
<li><code>pricePerDay</code> is how much wei it costs to rent the NFT for one day</li>
<li><code>startDateUNIX</code> is the UNIX timestamp for when the NFT is ready to be rented</li>
<li><code>endDateUNIX</code> is the UNIX timestamp for when the NFT should no longer be rentable</li>
<li><code>expires</code> is when the rental period for a user will end. If there is no renter, this is 0</li>
<li><code>rentalFee</code> is how much it costed to rent the NFT</li>
<li><code>refund</code> is for when the owner decides to unlist their NFT while someone is still renting it. In this case, the owner must refund the user however many days before the rental period was supposed to end.</li>
</ul>
<h3 class="mume-header" id="modify-the-marketplace-constructor">Modify the Marketplace Constructor</h3>

<p>Since we want to pass a listing fee to the marketplace owner whenever an NFT is listed, we&apos;ll need to store that information upon deployment. Modify the constructor as follows:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _marketOwner <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token property-access">sender</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="write-listnft">Write listNFT()</h3>

<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token comment">// function to list NFT for rental</span>
<span class="token keyword keyword-function">function</span> <span class="token function">listNFT</span><span class="token punctuation">(</span>
    <span class="token parameter">address nftContract<span class="token punctuation">,</span>
    uint256 tokenId<span class="token punctuation">,</span>
    uint256 pricePerDay<span class="token punctuation">,</span>
    uint256 startDateUNIX<span class="token punctuation">,</span>
    uint256 endDateUNIX</span>
<span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> payable nonReentrant <span class="token punctuation">{</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token function">isRentableNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Contract is not an ERC4907&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token constant">IERC721</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">ownerOf</span><span class="token punctuation">(</span>tokenId<span class="token punctuation">)</span> <span class="token operator">==</span> msg<span class="token punctuation">.</span><span class="token property-access">sender</span><span class="token punctuation">,</span> <span class="token string">&quot;Not owner of nft&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">==</span> _listingFee<span class="token punctuation">,</span> <span class="token string">&quot;Not enough ether for listing fee&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">require</span><span class="token punctuation">(</span>pricePerDay <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;Rental price should be greater than 0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">require</span><span class="token punctuation">(</span>startDateUNIX <span class="token operator">&gt;=</span> block<span class="token punctuation">.</span><span class="token property-access">timestamp</span><span class="token punctuation">,</span> <span class="token string">&quot;Start date cannot be in the past&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">require</span><span class="token punctuation">(</span>endDateUNIX <span class="token operator">&gt;=</span> startDateUNIX<span class="token punctuation">,</span> <span class="token string">&quot;End date cannot be before the start date&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">require</span><span class="token punctuation">(</span>_listingMap<span class="token punctuation">[</span>nftContract<span class="token punctuation">]</span><span class="token punctuation">[</span>tokenId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">nftContract</span> <span class="token operator">==</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;This NFT has already been listed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">payable</span><span class="token punctuation">(</span>_marketOwner<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">transfer</span><span class="token punctuation">(</span>_listingFee<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _listingMap<span class="token punctuation">[</span>nftContract<span class="token punctuation">]</span><span class="token punctuation">[</span>tokenId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function"><span class="token maybe-class-name">Listing</span></span><span class="token punctuation">(</span>
        msg<span class="token punctuation">.</span><span class="token property-access">sender</span><span class="token punctuation">,</span>
        <span class="token function">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        nftContract<span class="token punctuation">,</span>
        tokenId<span class="token punctuation">,</span>
        pricePerDay<span class="token punctuation">,</span>
        startDateUNIX<span class="token punctuation">,</span>
        endDateUNIX<span class="token punctuation">,</span>
        <span class="token number">0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    _nftsListed<span class="token punctuation">.</span><span class="token method function property-access">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span>_nftContractTokensMap<span class="token punctuation">[</span>nftContract<span class="token punctuation">]</span><span class="token punctuation">,</span> tokenId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span>_nftContracts<span class="token punctuation">,</span> nftContract<span class="token punctuation">)</span><span class="token punctuation">;</span>
    emit <span class="token function"><span class="token maybe-class-name">NFTListed</span></span><span class="token punctuation">(</span>
        <span class="token constant">IERC721</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">ownerOf</span><span class="token punctuation">(</span>tokenId<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        nftContract<span class="token punctuation">,</span>
        tokenId<span class="token punctuation">,</span>
        pricePerDay<span class="token punctuation">,</span>
        startDateUNIX<span class="token punctuation">,</span>
        endDateUNIX<span class="token punctuation">,</span>
        <span class="token number">0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p><code>listNFT</code> requires that:</p>
<ul>
<li>the NFT is ERC4907 and ERC721 compliant</li>
<li>the owner of the NFT is listing it</li>
<li>the listing properties (i.e. price, start date, end date) are valid values</li>
<li>the owner has enough ETH to cover the listing fee</li>
<li>the NFT has not already been listed</li>
</ul>
<p>We create a helper method <code>isRentableNFT</code> to check for the token standard compliance:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token keyword keyword-function">function</span> <span class="token function">isRentableNFT</span><span class="token punctuation">(</span><span class="token parameter">address nftContract</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bool _isRentable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    bool _isNFT <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-try">try</span> <span class="token constant">IERC165</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">supportsInterface</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token constant">IERC4907</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">interfaceId</span><span class="token punctuation">)</span> <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">bool rentable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _isRentable <span class="token operator">=</span> rentable<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow keyword-catch">catch</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow keyword-try">try</span> <span class="token constant">IERC165</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">supportsInterface</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token constant">IERC721</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">interfaceId</span><span class="token punctuation">)</span> <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">bool nft</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _isNFT <span class="token operator">=</span> nft<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow keyword-catch">catch</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow keyword-return">return</span> _isRentable <span class="token operator">&amp;&amp;</span> _isNFT<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>In particular, we check using Solidity&apos;s <code>try catch</code> syntax, since it is possible that the contract passed in does not support the ERC165 standard either. In that case, we want to gracefully fail and exit.</p>
<p>This method is public because we intend to call it in our frontend later to check for NFT validity.</p>
<p>Finally, <code>listNFT</code> simply transfers the listing fee over to the marketplace owner, and stores the relevant listing info. Note that the user is first set to the zero address and expires is set to 0 since no one has rented the NFT yet.</p>
<p>Do notice that we marked the function as <code>nonReentrant</code>, which is a modifier inherited from <code>ReentrancyGuard</code> to protect against reentrancy attacks, and <code>payable</code>, which ensures the function can send and receive ETH.</p>
<h3 class="mume-header" id="write-rentnft">Write rentNFT()</h3>

<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token comment">// function to rent an NFT</span>
<span class="token keyword keyword-function">function</span> <span class="token function">rentNFT</span><span class="token punctuation">(</span>
    <span class="token parameter">address nftContract<span class="token punctuation">,</span>
    uint256 tokenId<span class="token punctuation">,</span>
    uint64 expires</span>
<span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> payable nonReentrant <span class="token punctuation">{</span>
    <span class="token maybe-class-name">Listing</span> storage listing <span class="token operator">=</span> _listingMap<span class="token punctuation">[</span>nftContract<span class="token punctuation">]</span><span class="token punctuation">[</span>tokenId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">require</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span><span class="token property-access">user</span> <span class="token operator">==</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;NFT already rented&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">require</span><span class="token punctuation">(</span>expires <span class="token operator">&lt;=</span> listing<span class="token punctuation">.</span><span class="token property-access">endDateUNIX</span><span class="token punctuation">,</span> <span class="token string">&quot;Rental period exceeds max date rentable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Transfer rental fee</span>
    uint256 numDays <span class="token operator">=</span> <span class="token punctuation">(</span>expires <span class="token operator">-</span> block<span class="token punctuation">.</span><span class="token property-access">timestamp</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">60</span><span class="token operator">/</span><span class="token number">60</span><span class="token operator">/</span><span class="token number">24</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    uint256 rentalFee <span class="token operator">=</span> listing<span class="token punctuation">.</span><span class="token property-access">pricePerDay</span> <span class="token operator">*</span> numDays<span class="token punctuation">;</span>
    <span class="token function">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">&gt;=</span> rentalFee<span class="token punctuation">,</span> <span class="token string">&quot;Not enough ether to cover rental period&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">payable</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span><span class="token property-access">owner</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">transfer</span><span class="token punctuation">(</span>rentalFee<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Update listing</span>
    <span class="token constant">IERC4907</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">setUser</span><span class="token punctuation">(</span>tokenId<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token property-access">sender</span><span class="token punctuation">,</span> expires<span class="token punctuation">)</span><span class="token punctuation">;</span>
    listing<span class="token punctuation">.</span><span class="token property-access">user</span> <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token property-access">sender</span><span class="token punctuation">;</span>
    listing<span class="token punctuation">.</span><span class="token property-access">expires</span> <span class="token operator">=</span> expires<span class="token punctuation">;</span>

    emit <span class="token function"><span class="token maybe-class-name">NFTRented</span></span><span class="token punctuation">(</span>
        <span class="token constant">IERC721</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">ownerOf</span><span class="token punctuation">(</span>tokenId<span class="token punctuation">)</span><span class="token punctuation">,</span>
        msg<span class="token punctuation">.</span><span class="token property-access">sender</span><span class="token punctuation">,</span>
        nftContract<span class="token punctuation">,</span>
        tokenId<span class="token punctuation">,</span>
        listing<span class="token punctuation">.</span><span class="token property-access">startDateUNIX</span><span class="token punctuation">,</span>
        listing<span class="token punctuation">.</span><span class="token property-access">endDateUNIX</span><span class="token punctuation">,</span>
        expires<span class="token punctuation">,</span>
        rentalFee
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>This function handles the actual renting logic! We first grab the listing information and declare it as <code>storage</code>, since we want to modify contract state when we edit it. Again, we make some checks beforehand to ensure that the NFT can be rented, and the user has enough ETH to do so.</p>
<p>For this dapp, we assume the rental period starts right away. There is no ability to reserve NFTs later on. To calculate the number of days in a rental period, we add 1, because Solidity rounds down in integer division. After transferring the rental fee, we call <code>setUser</code> so that other dapps can check rental information on the NFT.</p>
<p>It is important to note that <code>setUser</code> requires that the Marketplace contract has approval to do so (if you recall from the implementation of it in episode 2). When we call this contract method in our dapp, we need to first call the ERC721 <code>approve</code> method to give it permission to do so. Otherwise, this transaction will fail.</p>
<h3 class="mume-header" id="write-unlistnft">Write unlistNFT()</h3>

<p><code>unlistNFT</code> allows the owner of the NFT to take down their listing. However, if they choose to do so while an NFT is still being rented, they must refund the user the appropriate amount for the days lost.</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token comment">// function to unlist your rental, refunding the user for any lost time</span>
<span class="token keyword keyword-function">function</span> <span class="token function">unlistNFT</span><span class="token punctuation">(</span><span class="token parameter">address nftContract<span class="token punctuation">,</span> uint256 tokenId</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> payable nonReentrant <span class="token punctuation">{</span>
    <span class="token maybe-class-name">Listing</span> storage listing <span class="token operator">=</span> _listingMap<span class="token punctuation">[</span>nftContract<span class="token punctuation">]</span><span class="token punctuation">[</span>tokenId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">require</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span><span class="token property-access">owner</span> <span class="token operator">!=</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;This NFT is not listed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">require</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span><span class="token property-access">owner</span> <span class="token operator">==</span> msg<span class="token punctuation">.</span><span class="token property-access">sender</span> <span class="token operator">||</span> _marketOwner <span class="token operator">==</span> msg<span class="token punctuation">.</span><span class="token property-access">sender</span> <span class="token punctuation">,</span> <span class="token string">&quot;Not approved to unlist NFT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// fee to be returned to user if unlisted before rental period is up</span>
    uint256 refund <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span><span class="token property-access">expires</span> <span class="token operator">-</span> block<span class="token punctuation">.</span><span class="token property-access">timestamp</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">60</span> <span class="token operator">/</span> <span class="token number">60</span> <span class="token operator">/</span> <span class="token number">24</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> listing<span class="token punctuation">.</span><span class="token property-access">pricePerDay</span><span class="token punctuation">;</span>
    <span class="token function">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">&gt;=</span> refund<span class="token punctuation">,</span> <span class="token string">&quot;Not enough ether to cover refund&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">payable</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">transfer</span><span class="token punctuation">(</span>refund<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// clean up data</span>
    <span class="token constant">IERC4907</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">setUser</span><span class="token punctuation">(</span>tokenId<span class="token punctuation">,</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token method function property-access">remove</span><span class="token punctuation">(</span>_nftContractTokensMap<span class="token punctuation">[</span>nftContract<span class="token punctuation">]</span><span class="token punctuation">,</span> tokenId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-delete">delete</span> _listingMap<span class="token punctuation">[</span>nftContract<span class="token punctuation">]</span><span class="token punctuation">[</span>tokenId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-if">if</span> <span class="token punctuation">(</span><span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token method function property-access">length</span><span class="token punctuation">(</span>_nftContractTokensMap<span class="token punctuation">[</span>nftContract<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token method function property-access">remove</span><span class="token punctuation">(</span>_nftContracts<span class="token punctuation">,</span> nftContract<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _nftsListed<span class="token punctuation">.</span><span class="token method function property-access">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    emit <span class="token function"><span class="token maybe-class-name">NFTUnlisted</span></span><span class="token punctuation">(</span>
        msg<span class="token punctuation">.</span><span class="token property-access">sender</span><span class="token punctuation">,</span>
        nftContract<span class="token punctuation">,</span>
        tokenId<span class="token punctuation">,</span>
        refund
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>Again, we validate that:</p>
<ul>
<li>The NFT is listed</li>
<li>Only the owner or marketplace owner can unlist an NFT</li>
<li>Enough ETH is available to refund the user</li>
</ul>
<p>At the end, we want to clean up our data, which entails:</p>
<ul>
<li>Removing the rental info from the NFT</li>
<li>Removing the NFT from the stored listings</li>
</ul>
<h3 class="mume-header" id="write-getalllistings">Write getAllListings()</h3>

<p>This function returns all the listings stored, regardless of whether or not the rental period has expired or the time is not within startDateUNIX and endDateUNIX. While this is possible to do in Solidity, this kind of filtering should be handled off-chain to reduce gas costs.</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token comment">/* 
* function to get all listings
*
* WARNING: This operation will copy the entire storage to memory, which can be quite expensive. This is designed
* to mostly be used by view accessors that are queried without any gas fees. Developers should keep in mind that
* this function has an unbounded cost, and using it as part of a state-changing function may render the function
* uncallable if the set grows to a point where copying to memory consumes too much gas to fit in a block.
*/</span>
<span class="token keyword keyword-function">function</span> <span class="token function">getAllListings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token maybe-class-name">Listing</span><span class="token punctuation">[</span><span class="token punctuation">]</span> memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token maybe-class-name">Listing</span><span class="token punctuation">[</span><span class="token punctuation">]</span> memory listings <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Listing</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>_nftsListed<span class="token punctuation">.</span><span class="token method function property-access">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uint256 listingsIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    address<span class="token punctuation">[</span><span class="token punctuation">]</span> memory nftContracts <span class="token operator">=</span> <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token method function property-access">values</span><span class="token punctuation">(</span>_nftContracts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-for">for</span> <span class="token punctuation">(</span>uint i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nftContracts<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        address nftAddress <span class="token operator">=</span> nftContracts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        uint256<span class="token punctuation">[</span><span class="token punctuation">]</span> memory tokens <span class="token operator">=</span> <span class="token maybe-class-name">EnumerableSet</span><span class="token punctuation">.</span><span class="token method function property-access">values</span><span class="token punctuation">(</span>_nftContractTokensMap<span class="token punctuation">[</span>nftAddress<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword control-flow keyword-for">for</span> <span class="token punctuation">(</span>uint j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> tokens<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            listings<span class="token punctuation">[</span>listingsIndex<span class="token punctuation">]</span> <span class="token operator">=</span> _listingMap<span class="token punctuation">[</span>nftAddress<span class="token punctuation">]</span><span class="token punctuation">[</span>tokens<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            listingsIndex<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow keyword-return">return</span> listings<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>As mentioned before, Solidity maps are not iterable. In order to get around it, we store the keys we want to step over in two separate arrays. Given this is an unbounded list, be careful not to call this in the context of a state change. Otherwise, the computational costs could get very high and the transaction would fail due to gas costs.</p>
<h3 class="mume-header" id="write-getlistingfee">Write getListingFee()</h3>

<p>Finally, we have a simple helper function to expose the listing fee in our tests and scripts.</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token keyword keyword-function">function</span> <span class="token function">getListingFee</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow keyword-return">return</span> _listingFee<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h2 class="mume-header" id="modify-rentablenft">Modify RentableNft</h2>

<p>There&apos;s actually one last piece we need to handle! For our marketplace smart contract, we want to give it automatic approval for NFTs minted from the <code>RentableNFT</code> contract. To do so, we need to pass in the marketplace contract address to <code>RentableNFT</code> and set the approval in the mint function.</p>
<p>Modify the constructor and contract variables in <code>RentableNft</code>:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript">contract <span class="token maybe-class-name">RentableNft</span> is <span class="token constant">ERC4907</span> <span class="token punctuation">{</span>
using <span class="token maybe-class-name">Counters</span> <span class="token keyword control-flow keyword-for">for</span> <span class="token maybe-class-name">Counters</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">;</span>
address <span class="token keyword keyword-private">private</span> _marketplaceContract<span class="token punctuation">;</span>
<span class="token maybe-class-name">Counters</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Counter</span></span> <span class="token keyword keyword-private">private</span> _tokenIds<span class="token punctuation">;</span>

<span class="token function">constructor</span><span class="token punctuation">(</span>address marketplaceContract<span class="token punctuation">)</span> <span class="token constant">ERC4907</span><span class="token punctuation">(</span><span class="token string">&quot;RentableNft&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RNFT&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _marketplaceContract <span class="token operator">=</span> marketplaceContract<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>Lastly, modify <code>mint</code> to set the approval:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token keyword keyword-function">function</span> <span class="token function">mint</span><span class="token punctuation">(</span><span class="token parameter">string memory _tokenURI</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> <span class="token punctuation">{</span>
    _tokenIds<span class="token punctuation">.</span><span class="token method function property-access">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uint256 newTokenId <span class="token operator">=</span> _tokenIds<span class="token punctuation">.</span><span class="token method function property-access">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_safeMint</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token property-access">sender</span><span class="token punctuation">,</span> newTokenId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setApprovalForAll</span><span class="token punctuation">(</span>_marketplaceContract<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_setTokenURI</span><span class="token punctuation">(</span>newTokenId<span class="token punctuation">,</span> _tokenURI<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><h2 class="mume-header" id="modify-1_deploy_contractjs">Modify 1_deploy_contract.js</h2>

<p>Now, we need to deploy our Marketplace contract, passing in its address to the RentableNft constructor to set approvals. Your migration file should look like this:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token keyword keyword-const">const</span> <span class="token maybe-class-name">RentableNft</span> <span class="token operator">=</span> artifacts<span class="token punctuation">.</span><span class="token method function property-access">require</span><span class="token punctuation">(</span><span class="token string">&quot;RentableNft&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token maybe-class-name">Marketplace</span> <span class="token operator">=</span> artifacts<span class="token punctuation">.</span><span class="token method function property-access">require</span><span class="token punctuation">(</span><span class="token string">&quot;Marketplace&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token punctuation">(</span><span class="token parameter">deployer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow keyword-await">await</span> deployer<span class="token punctuation">.</span><span class="token method function property-access">deploy</span><span class="token punctuation">(</span><span class="token maybe-class-name">Marketplace</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-const">const</span> marketplace <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> <span class="token maybe-class-name">Marketplace</span><span class="token punctuation">.</span><span class="token method function property-access">deployed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow keyword-await">await</span> deployer<span class="token punctuation">.</span><span class="token method function property-access">deploy</span><span class="token punctuation">(</span><span class="token maybe-class-name">RentableNft</span><span class="token punctuation">,</span> marketplace<span class="token punctuation">.</span><span class="token property-access">address</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><h2 class="mume-header" id="write-tests">Write Tests</h2>

<p>Our marketplace contract is done! Now, it&apos;s time to write tests.</p>
<pre data-role="codeBlock" data-info="shell" class="language-shell">truffle create <span class="token builtin class-name">test</span> TestMarketplace
</pre><p>Your completed test should look like this:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@openzeppelin/test-helpers/configure&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  provider<span class="token operator">:</span> web3<span class="token punctuation">.</span><span class="token property-access">currentProvider</span><span class="token punctuation">,</span>
  singletons<span class="token operator">:</span> <span class="token punctuation">{</span>
    abstraction<span class="token operator">:</span> <span class="token string">&quot;truffle&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> balance<span class="token punctuation">,</span> constants<span class="token punctuation">,</span> ether<span class="token punctuation">,</span> expectRevert<span class="token punctuation">,</span> expectEvent <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;@openzeppelin/test-helpers&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token maybe-class-name">Marketplace</span> <span class="token operator">=</span> artifacts<span class="token punctuation">.</span><span class="token method function property-access">require</span><span class="token punctuation">(</span><span class="token string">&quot;Marketplace&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token maybe-class-name">RentableNft</span> <span class="token operator">=</span> artifacts<span class="token punctuation">.</span><span class="token method function property-access">require</span><span class="token punctuation">(</span><span class="token string">&quot;RentableNft&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-const">const</span> <span class="token constant">TODAY</span> <span class="token operator">=</span> <span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">floor</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">TODAY_2</span> <span class="token operator">=</span> <span class="token constant">TODAY</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">YESTERDAY</span> <span class="token operator">=</span> <span class="token constant">TODAY</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">TOMORROW</span> <span class="token operator">=</span> <span class="token constant">TODAY</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">IN_FIVE_DAYS</span> <span class="token operator">=</span> <span class="token constant">TODAY</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-function">function</span> <span class="token function">assertListing</span><span class="token punctuation">(</span><span class="token parameter">actual<span class="token punctuation">,</span> expected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  assert<span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span>actual<span class="token punctuation">.</span><span class="token property-access">owner</span><span class="token punctuation">,</span> expected<span class="token punctuation">.</span><span class="token property-access">owner</span><span class="token punctuation">,</span> <span class="token string">&quot;Owner is not correct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  assert<span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span>actual<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">,</span> expected<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">,</span> <span class="token string">&quot;User is not correct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  assert<span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span>actual<span class="token punctuation">.</span><span class="token property-access">nftContract</span><span class="token punctuation">,</span> expected<span class="token punctuation">.</span><span class="token property-access">nftContract</span><span class="token punctuation">,</span> <span class="token string">&quot;NFT contract is not correct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  assert<span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span>actual<span class="token punctuation">.</span><span class="token property-access">tokenId</span><span class="token punctuation">,</span> expected<span class="token punctuation">.</span><span class="token property-access">tokenId</span><span class="token punctuation">,</span> <span class="token string">&quot;TokenId is not correct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  assert<span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span>actual<span class="token punctuation">.</span><span class="token property-access">pricePerDay</span><span class="token punctuation">,</span> expected<span class="token punctuation">.</span><span class="token property-access">pricePerDay</span><span class="token punctuation">,</span> <span class="token string">&quot;Price per day is not correct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  assert<span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span>actual<span class="token punctuation">.</span><span class="token property-access">startDateUNIX</span><span class="token punctuation">,</span> expected<span class="token punctuation">.</span><span class="token property-access">startDateUNIX</span><span class="token punctuation">,</span> <span class="token string">&quot;Start date is not correct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  assert<span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span>actual<span class="token punctuation">.</span><span class="token property-access">endDateUNIX</span><span class="token punctuation">,</span> expected<span class="token punctuation">.</span><span class="token property-access">endDateUNIX</span><span class="token punctuation">,</span> <span class="token string">&quot;End date is not correct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  assert<span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span>actual<span class="token punctuation">.</span><span class="token property-access">expires</span><span class="token punctuation">,</span> expected<span class="token punctuation">.</span><span class="token property-access">expires</span><span class="token punctuation">,</span> <span class="token string">&quot;Expires date is not correct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token function">assertNFT</span><span class="token punctuation">(</span><span class="token parameter">nftContractInstance<span class="token punctuation">,</span> tokenId<span class="token punctuation">,</span> expectedUser<span class="token punctuation">,</span> expectedExpires</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-let">let</span> user <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> nftContractInstance<span class="token punctuation">.</span><span class="token method function property-access">userOf</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span>tokenId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-let">let</span> expires <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> nftContractInstance<span class="token punctuation">.</span><span class="token method function property-access">userExpires</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span>tokenId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  assert<span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> expectedUser<span class="token punctuation">,</span> <span class="token string">&quot;User is not correct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  assert<span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span>expires<span class="token punctuation">,</span> expectedExpires<span class="token punctuation">,</span> <span class="token string">&quot;Expires date is incorrect&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// EnumerableSet makes no guarantee about ordering, so we have to find the matching tokenId</span>
<span class="token keyword keyword-function">function</span> <span class="token function">getListing</span><span class="token punctuation">(</span><span class="token parameter">listings<span class="token punctuation">,</span> tokenId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-let">let</span> listing <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  listings<span class="token punctuation">.</span><span class="token method function property-access">every</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_listing</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow keyword-if">if</span> <span class="token punctuation">(</span>_listing<span class="token punctuation">.</span><span class="token property-access">tokenId</span> <span class="token operator">==</span> tokenId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      listing <span class="token operator">=</span> _listing<span class="token punctuation">;</span>
      <span class="token keyword control-flow keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow keyword-else">else</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow keyword-return">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow keyword-return">return</span> listing
<span class="token punctuation">}</span>

<span class="token keyword keyword-function">function</span> <span class="token function">listingToString</span><span class="token punctuation">(</span><span class="token parameter">listing</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-let">let</span> listingCopy <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token spread operator">...</span>listing<span class="token punctuation">}</span><span class="token punctuation">;</span>
  listingCopy<span class="token punctuation">.</span><span class="token property-access">tokenId</span> <span class="token operator">=</span> listing<span class="token punctuation">.</span><span class="token property-access">tokenId</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  listingCopy<span class="token punctuation">.</span><span class="token property-access">pricePerDay</span> <span class="token operator">=</span> listing<span class="token punctuation">.</span><span class="token property-access">pricePerDay</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  listingCopy<span class="token punctuation">.</span><span class="token property-access">startDateUNIX</span> <span class="token operator">=</span> listing<span class="token punctuation">.</span><span class="token property-access">startDateUNIX</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  listingCopy<span class="token punctuation">.</span><span class="token property-access">endDateUNIX</span> <span class="token operator">=</span> listing<span class="token punctuation">.</span><span class="token property-access">endDateUNIX</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  listingCopy<span class="token punctuation">.</span><span class="token property-access">expires</span> <span class="token operator">=</span> listing<span class="token punctuation">.</span><span class="token property-access">expires</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow keyword-if">if</span> <span class="token punctuation">(</span><span class="token string">&quot;rentalFee&quot;</span> <span class="token keyword keyword-in">in</span> listing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    listingCopy<span class="token punctuation">.</span><span class="token property-access">rentalFee</span> <span class="token operator">=</span> listing<span class="token punctuation">.</span><span class="token property-access">rentalFee</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">contract</span><span class="token punctuation">(</span><span class="token string">&quot;Marketplace&quot;</span><span class="token punctuation">,</span> <span class="token keyword keyword-function">function</span> <span class="token punctuation">(</span><span class="token parameter">accounts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> <span class="token constant">MARKETPLACE_OWNER</span> <span class="token operator">=</span> accounts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-const">const</span> <span class="token constant">TOKEN_OWNER</span> <span class="token operator">=</span> accounts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-const">const</span> <span class="token constant">USER</span> <span class="token operator">=</span> accounts<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-let">let</span> marketplace<span class="token punctuation">;</span>
  <span class="token keyword keyword-let">let</span> rentableNft<span class="token punctuation">;</span>
  <span class="token keyword keyword-let">let</span> nftContract<span class="token punctuation">;</span>
  <span class="token keyword keyword-let">let</span> listingFee<span class="token punctuation">;</span>

  <span class="token function">before</span><span class="token punctuation">(</span><span class="token string">&apos;should reuse variables&apos;</span><span class="token punctuation">,</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
    marketplace <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> <span class="token maybe-class-name">Marketplace</span><span class="token punctuation">.</span><span class="token method function property-access">deployed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rentableNft <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> <span class="token maybe-class-name">RentableNft</span><span class="token punctuation">.</span><span class="token method function property-access">deployed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nftContract <span class="token operator">=</span> rentableNft<span class="token punctuation">.</span><span class="token property-access">address</span><span class="token punctuation">;</span>
    listingFee <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword control-flow keyword-await">await</span> marketplace<span class="token punctuation">.</span><span class="token method function property-access">getListingFee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// mint nfts for testing</span>
    <span class="token keyword control-flow keyword-await">await</span> rentableNft<span class="token punctuation">.</span><span class="token method function property-access">mint</span><span class="token punctuation">(</span><span class="token string">&quot;fakeURI&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">TOKEN_OWNER</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-await">await</span> rentableNft<span class="token punctuation">.</span><span class="token method function property-access">mint</span><span class="token punctuation">(</span><span class="token string">&quot;fakeURI&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">TOKEN_OWNER</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-await">await</span> rentableNft<span class="token punctuation">.</span><span class="token method function property-access">mint</span><span class="token punctuation">(</span><span class="token string">&quot;fakeURI&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">TOKEN_OWNER</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;should list nfts&quot;</span><span class="token punctuation">,</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-let">let</span> tracker <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> balance<span class="token punctuation">.</span><span class="token method function property-access">tracker</span><span class="token punctuation">(</span><span class="token constant">MARKETPLACE_OWNER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-await">await</span> tracker<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-let">let</span> txn <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> marketplace<span class="token punctuation">.</span><span class="token method function property-access">listNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">TOMORROW</span><span class="token punctuation">,</span> <span class="token constant">IN_FIVE_DAYS</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">TOKEN_OWNER</span><span class="token punctuation">,</span> value<span class="token operator">:</span> listingFee<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    assert<span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span><span class="token keyword control-flow keyword-await">await</span> tracker<span class="token punctuation">.</span><span class="token method function property-access">delta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> listingFee<span class="token punctuation">,</span> <span class="token string">&quot;Listing fee not transferred&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-let">let</span> expectedListing <span class="token operator">=</span> <span class="token punctuation">{</span>
      owner<span class="token operator">:</span> <span class="token constant">TOKEN_OWNER</span><span class="token punctuation">,</span>
      user<span class="token operator">:</span> constants<span class="token punctuation">.</span><span class="token constant">ZERO_ADDRESS</span><span class="token punctuation">,</span>
      nftContract<span class="token operator">:</span> nftContract<span class="token punctuation">,</span>
      tokenId<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      pricePerDay<span class="token operator">:</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      startDateUNIX<span class="token operator">:</span> <span class="token constant">TOMORROW</span><span class="token punctuation">,</span>
      endDateUNIX<span class="token operator">:</span> <span class="token constant">IN_FIVE_DAYS</span><span class="token punctuation">,</span>
      expires<span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">assertListing</span><span class="token punctuation">(</span><span class="token function">getListing</span><span class="token punctuation">(</span><span class="token keyword control-flow keyword-await">await</span> marketplace<span class="token punctuation">.</span><span class="token method function property-access">getAllListings</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expectedListing<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expectEvent</span><span class="token punctuation">(</span>txn<span class="token punctuation">,</span> <span class="token string">&quot;NFTListed&quot;</span><span class="token punctuation">,</span> <span class="token function">listingToString</span><span class="token punctuation">(</span>expectedListing<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-await">await</span> tracker<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    txn <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> marketplace<span class="token punctuation">.</span><span class="token method function property-access">listNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;.5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">TOMORROW</span><span class="token punctuation">,</span> <span class="token constant">IN_FIVE_DAYS</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">TOKEN_OWNER</span><span class="token punctuation">,</span> value<span class="token operator">:</span> listingFee<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    assert<span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span><span class="token keyword control-flow keyword-await">await</span> tracker<span class="token punctuation">.</span><span class="token method function property-access">delta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> listingFee<span class="token punctuation">,</span> <span class="token string">&quot;Listing fee not transferred&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    expectedListing<span class="token punctuation">.</span><span class="token property-access">tokenId</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    expectedListing<span class="token punctuation">.</span><span class="token property-access">pricePerDay</span> <span class="token operator">=</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;.5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    expectedListing<span class="token punctuation">.</span><span class="token property-access">startDateUNIX</span> <span class="token operator">=</span> <span class="token constant">TOMORROW</span><span class="token punctuation">;</span>
    expectedListing<span class="token punctuation">.</span><span class="token property-access">endDateUNIX</span> <span class="token operator">=</span> <span class="token constant">IN_FIVE_DAYS</span><span class="token punctuation">;</span>
    expectedListing<span class="token punctuation">.</span><span class="token property-access">expires</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">assertListing</span><span class="token punctuation">(</span><span class="token function">getListing</span><span class="token punctuation">(</span><span class="token keyword control-flow keyword-await">await</span> marketplace<span class="token punctuation">.</span><span class="token method function property-access">getAllListings</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expectedListing<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expectEvent</span><span class="token punctuation">(</span>txn<span class="token punctuation">,</span> <span class="token string">&quot;NFTListed&quot;</span><span class="token punctuation">,</span> <span class="token function">listingToString</span><span class="token punctuation">(</span>expectedListing<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;should validate listings&quot;</span><span class="token punctuation">,</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow keyword-await">await</span> <span class="token function">expectRevert</span><span class="token punctuation">(</span>
      marketplace<span class="token punctuation">.</span><span class="token method function property-access">listNFT</span><span class="token punctuation">(</span>marketplace<span class="token punctuation">.</span><span class="token property-access">address</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">TOMORROW</span><span class="token punctuation">,</span> <span class="token constant">IN_FIVE_DAYS</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">TOKEN_OWNER</span><span class="token punctuation">,</span> value<span class="token operator">:</span> listingFee<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;Contract is not an ERC4907&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-await">await</span> <span class="token function">expectRevert</span><span class="token punctuation">(</span>
      marketplace<span class="token punctuation">.</span><span class="token method function property-access">listNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">TOMORROW</span><span class="token punctuation">,</span> <span class="token constant">IN_FIVE_DAYS</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> accounts<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token operator">:</span> listingFee<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;Not owner of nft&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-await">await</span> <span class="token function">expectRevert</span><span class="token punctuation">(</span>
      marketplace<span class="token punctuation">.</span><span class="token method function property-access">listNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">TOMORROW</span><span class="token punctuation">,</span> <span class="token constant">IN_FIVE_DAYS</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">TOKEN_OWNER</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;Not enough ether for listing fee&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-await">await</span> <span class="token function">expectRevert</span><span class="token punctuation">(</span>
      marketplace<span class="token punctuation">.</span><span class="token method function property-access">listNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">TOMORROW</span><span class="token punctuation">,</span> <span class="token constant">IN_FIVE_DAYS</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">TOKEN_OWNER</span><span class="token punctuation">,</span> value<span class="token operator">:</span> listingFee<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;Rental price should be greater than 0&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-await">await</span> <span class="token function">expectRevert</span><span class="token punctuation">(</span>
      marketplace<span class="token punctuation">.</span><span class="token method function property-access">listNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">YESTERDAY</span><span class="token punctuation">,</span> <span class="token constant">IN_FIVE_DAYS</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">TOKEN_OWNER</span><span class="token punctuation">,</span> value<span class="token operator">:</span> listingFee<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;Start date cannot be in the past&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-await">await</span> <span class="token function">expectRevert</span><span class="token punctuation">(</span>
      marketplace<span class="token punctuation">.</span><span class="token method function property-access">listNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">IN_FIVE_DAYS</span><span class="token punctuation">,</span> <span class="token constant">YESTERDAY</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">TOKEN_OWNER</span><span class="token punctuation">,</span> value<span class="token operator">:</span> listingFee<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;End date cannot be before the start date&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-await">await</span> <span class="token function">expectRevert</span><span class="token punctuation">(</span>
      marketplace<span class="token punctuation">.</span><span class="token method function property-access">listNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">TOMORROW</span><span class="token punctuation">,</span> <span class="token constant">IN_FIVE_DAYS</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">TOKEN_OWNER</span><span class="token punctuation">,</span> value<span class="token operator">:</span> listingFee<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;This NFT has already been listed&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;should modify listings and nft contract when nft is rented&quot;</span><span class="token punctuation">,</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assertNFT</span><span class="token punctuation">(</span>rentableNft<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> constants<span class="token punctuation">.</span><span class="token constant">ZERO_ADDRESS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertNFT</span><span class="token punctuation">(</span>rentableNft<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> constants<span class="token punctuation">.</span><span class="token constant">ZERO_ADDRESS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-let">let</span> tracker <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> balance<span class="token punctuation">.</span><span class="token method function property-access">tracker</span><span class="token punctuation">(</span><span class="token constant">TOKEN_OWNER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-await">await</span> tracker<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-let">let</span> txn <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> marketplace<span class="token punctuation">.</span><span class="token method function property-access">rentNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">TODAY_2</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">USER</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1 day rental, pricePerDay is 1</span>
    assert<span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword control-flow keyword-await">await</span> tracker<span class="token punctuation">.</span><span class="token method function property-access">delta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;One day rental fee is not correct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-let">let</span> listing <span class="token operator">=</span> <span class="token function">getListing</span><span class="token punctuation">(</span><span class="token keyword control-flow keyword-await">await</span> marketplace<span class="token punctuation">.</span><span class="token method function property-access">getAllListings</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-let">let</span> expectedListing <span class="token operator">=</span> <span class="token punctuation">{</span>
      owner<span class="token operator">:</span> <span class="token constant">TOKEN_OWNER</span><span class="token punctuation">,</span>
      user<span class="token operator">:</span> <span class="token constant">USER</span><span class="token punctuation">,</span>
      nftContract<span class="token operator">:</span> nftContract<span class="token punctuation">,</span>
      tokenId<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      pricePerDay<span class="token operator">:</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      startDateUNIX<span class="token operator">:</span> <span class="token constant">TOMORROW</span><span class="token punctuation">,</span>
      endDateUNIX<span class="token operator">:</span> <span class="token constant">IN_FIVE_DAYS</span><span class="token punctuation">,</span>
      expires<span class="token operator">:</span> <span class="token constant">TODAY_2</span><span class="token punctuation">,</span>
      rentalFee<span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">assertListing</span><span class="token punctuation">(</span>listing<span class="token punctuation">,</span> expectedListing<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertNFT</span><span class="token punctuation">(</span>rentableNft<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">USER</span><span class="token punctuation">,</span> <span class="token constant">TODAY_2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expectEvent</span><span class="token punctuation">(</span>txn<span class="token punctuation">,</span> <span class="token string">&quot;NFTRented&quot;</span><span class="token punctuation">,</span> <span class="token function">listingToString</span><span class="token punctuation">(</span>expectedListing<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-await">await</span> tracker<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    txn <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> marketplace<span class="token punctuation">.</span><span class="token method function property-access">rentNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token constant">IN_FIVE_DAYS</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">USER</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;2.5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    assert<span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword control-flow keyword-await">await</span> tracker<span class="token punctuation">.</span><span class="token method function property-access">delta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;2.5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Five day rental fee is not correct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    listing <span class="token operator">=</span> <span class="token function">getListing</span><span class="token punctuation">(</span><span class="token keyword control-flow keyword-await">await</span> marketplace<span class="token punctuation">.</span><span class="token method function property-access">getAllListings</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    expectedListing<span class="token punctuation">.</span><span class="token property-access">tokenId</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    expectedListing<span class="token punctuation">.</span><span class="token property-access">pricePerDay</span> <span class="token operator">=</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;.5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    expectedListing<span class="token punctuation">.</span><span class="token property-access">expires</span> <span class="token operator">=</span> <span class="token constant">IN_FIVE_DAYS</span><span class="token punctuation">;</span>
    expectedListing<span class="token punctuation">.</span><span class="token property-access">rentalFee</span> <span class="token operator">=</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;2.5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertListing</span><span class="token punctuation">(</span>listing<span class="token punctuation">,</span> expectedListing<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertNFT</span><span class="token punctuation">(</span>rentableNft<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token constant">USER</span><span class="token punctuation">,</span> <span class="token constant">IN_FIVE_DAYS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expectEvent</span><span class="token punctuation">(</span>txn<span class="token punctuation">,</span> <span class="token string">&quot;NFTRented&quot;</span><span class="token punctuation">,</span> <span class="token function">listingToString</span><span class="token punctuation">(</span>expectedListing<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;should validate rentals&quot;</span><span class="token punctuation">,</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow keyword-await">await</span> <span class="token function">expectRevert</span><span class="token punctuation">(</span>
      marketplace<span class="token punctuation">.</span><span class="token method function property-access">rentNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">TODAY_2</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">USER</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;NFT already rented&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-await">await</span> marketplace<span class="token punctuation">.</span><span class="token method function property-access">listNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">TOMORROW</span><span class="token punctuation">,</span> <span class="token constant">IN_FIVE_DAYS</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">TOKEN_OWNER</span><span class="token punctuation">,</span> value<span class="token operator">:</span> listingFee<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-await">await</span> <span class="token function">expectRevert</span><span class="token punctuation">(</span>
      marketplace<span class="token punctuation">.</span><span class="token method function property-access">rentNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token constant">IN_FIVE_DAYS</span> <span class="token operator">+</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">USER</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;2.5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;Rental period exceeds max date rentable&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-await">await</span> <span class="token function">expectRevert</span><span class="token punctuation">(</span>
      marketplace<span class="token punctuation">.</span><span class="token method function property-access">rentNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token constant">TOMORROW</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">USER</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;Not enough ether to cover rental period&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;should validate unlisting&quot;</span><span class="token punctuation">,</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow keyword-await">await</span> <span class="token function">expectRevert</span><span class="token punctuation">(</span>
      marketplace<span class="token punctuation">.</span><span class="token method function property-access">unlistNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">TOKEN_OWNER</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;2.5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;This NFT is not listed&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-await">await</span> <span class="token function">expectRevert</span><span class="token punctuation">(</span>
      marketplace<span class="token punctuation">.</span><span class="token method function property-access">unlistNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">USER</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;2.5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;Not approved to unlist NFT&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-await">await</span> <span class="token function">expectRevert</span><span class="token punctuation">(</span>
      marketplace<span class="token punctuation">.</span><span class="token method function property-access">unlistNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">TOKEN_OWNER</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;Not enough ether to cover refund&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;should refund USER and cleanup listings if unlisted&quot;</span><span class="token punctuation">,</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-let">let</span> tracker <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> balance<span class="token punctuation">.</span><span class="token method function property-access">tracker</span><span class="token punctuation">(</span><span class="token constant">USER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow keyword-await">await</span> tracker<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-let">let</span> txn <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> marketplace<span class="token punctuation">.</span><span class="token method function property-access">unlistNFT</span><span class="token punctuation">(</span>nftContract<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> <span class="token constant">TOKEN_OWNER</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;2.5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    assert<span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword control-flow keyword-await">await</span> tracker<span class="token punctuation">.</span><span class="token method function property-access">delta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;2.5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Refunded amount is not correct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-let">let</span> listing <span class="token operator">=</span> <span class="token function">getListing</span><span class="token punctuation">(</span><span class="token keyword control-flow keyword-await">await</span> marketplace<span class="token punctuation">.</span><span class="token method function property-access">getAllListings</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    assert<span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span>listing<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;NFT was not unlisted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertNFT</span><span class="token punctuation">(</span>rentableNft<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> constants<span class="token punctuation">.</span><span class="token constant">ZERO_ADDRESS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expectEvent</span><span class="token punctuation">(</span>txn<span class="token punctuation">,</span> <span class="token string">&quot;NFTUnlisted&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      unlistSender<span class="token operator">:</span> <span class="token constant">TOKEN_OWNER</span><span class="token punctuation">,</span>
      nftContract<span class="token operator">:</span> nftContract<span class="token punctuation">,</span>
      tokenId<span class="token operator">:</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
      refund<span class="token operator">:</span> <span class="token function">ether</span><span class="token punctuation">(</span><span class="token string">&quot;2.5&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>There is a lot to unpack here, so we&apos;ll just cover the highlights.</p>
<p>At the top of the file, we declare some constants that will help us write our tests. Additionally, we define helper assertion methods to reduce code duplication in our tests:</p>
<ul>
<li><code>assertListing</code> asserts that a Listing object is equal to an expected Listing object.</li>
<li><code>assertNFT</code> asserts that the ERC4907 rental info was properly set.</li>
<li><code>getListing</code> returns the listing corresponding to the passed in tokenID in a list of listings.</li>
<li><code>listingToString</code> converts the values of a listing into a string, since <code>expectEvent</code> expects the values of the emitted event to be a string</li>
</ul>
<p>Before the tests run, we first mint 3 NFTs to be used throughout the test.</p>
<p>To test that balances were correctly transferred, we use <a href="https://docs.openzeppelin.com/test-helpers/0.5/api#tracker">OpenZeppelin&apos;s <code>tracker</code></a>. This is really handy because the prices are reflected in wei, which need to be wrapped in a javascript BigNumber, and <code>tracker</code> takes care of that logic!</p>
<p>Run <code>truffle test</code> to check that the tests pass:</p>
<pre data-role="codeBlock" data-info="shell" class="language-shell">Contract: Marketplace
    &#x2714; should list nfts <span class="token punctuation">(</span>473ms<span class="token punctuation">)</span>
    &#x2714; should validate listings <span class="token punctuation">(</span>400ms<span class="token punctuation">)</span>
    &#x2714; should modify listings and nft contract when nft is rented <span class="token punctuation">(</span>241ms<span class="token punctuation">)</span>
    &#x2714; should validate rentals <span class="token punctuation">(</span>149ms<span class="token punctuation">)</span>
    &#x2714; should validate unlisting
    &#x2714; should refund <span class="token environment constant">USER</span> and cleanup listings <span class="token keyword keyword-if">if</span> unlisted <span class="token punctuation">(</span>54ms<span class="token punctuation">)</span>

Contract: RentableNft
&#x2714; should support the ERC721 and ERC4907 standards
&#x2714; should not <span class="token builtin class-name">set</span> UserInfo <span class="token keyword keyword-if">if</span> not the owner <span class="token punctuation">(</span>48ms<span class="token punctuation">)</span>
&#x2714; should <span class="token builtin class-name">return</span> the correct UserInfo <span class="token punctuation">(</span>150ms<span class="token punctuation">)</span>


<span class="token number">9</span> passing <span class="token punctuation">(</span>2s<span class="token punctuation">)</span>
</pre><p>If you run into issues testing, using the <a href="https://trufflesuite.com/docs/truffle/getting-started/using-the-truffle-debugger/">Truffle debugger</a> is really helpful! Watch the livestream for help testing reverted transactions!</p>
<h2 class="mume-header" id="write-scripts-to-test-with-deployed-contracts">Write Scripts to Test with Deployed Contracts</h2>

<p>Now that we have our rental marketplace up and running, let&apos;s try testing it with a RentablePets contract we previously deployed! We can use ganache forking to mimic the state of the testnet or mainnet and interact with already deployed contracts.</p>
<h3 class="mume-header" id="deploy-the-rentablepets-contract-to-goerli">Deploy the RentablePets contract to Goerli</h3>

<p>First, let&apos;s deploy the <code>RentablePets</code> contract to Goerli. If you haven&apos;t already done so, clone the <a href="https://github.com/trufflesuite/unleashed_rentable_nft"><code>unleashed_rentable_nft</code> repo</a>. Then, let&apos;s deploy it to the Goerli testnet using Truffle dashboard! To do so, let&apos;s add our Infura Goerli endpoint to our MetaMask wallet. First get your Infura endpoint from your Infura dashboard, and then navigate to Add Networks in MetaMask.</p>
<p><img src="./img/infura_dashboard.png" alt="Infura endpoint"></p>
<p><img src="./img/goerlidev.png" alt="MetaMask wallet"></p>
<p>Make sure your MetaMask wallet is connected to <code>goerlidev</code> and run:</p>
<pre data-role="codeBlock" data-info="shell" class="language-shell">truffle dashboard
truffle migrate --network dashboard
</pre><p>This should bring up Truffle dashboard on localhost:24012 and prompt you to sign the deployment. After that&apos;s been deployed, now let&apos;s verify it!</p>
<h3 class="mume-header" id="verify-rentablepets">Verify RentablePets</h3>

<p>Follow these steps (here)[<a href="https://github.com/rkalis/truffle-plugin-verify">https://github.com/rkalis/truffle-plugin-verify</a>]</p>
<p>We recommend verifying with dashboard:</p>
<p><code>truffle run verify RentablePets --network dashboard</code></p>
<p>You might run into issues with the OpenZeppelin contracts being in the <code>node_modules</code> folder. If so, go ahead and copy the necessary ones from <code>node_modules</code> into the <code>contracts</code> folder and change the import paths in <code>RentablePets.sol</code> and <code>ERC4907.sol</code>. Then you&apos;ll need to redeploy and follow the verify steps again.</p>
<p>If you would like, just clone the <a href="https://github.com/trufflesuite/unleashed_rentable_nft/tree/verify-contract"><code>verify-contract</code> branch</a> of the unleashed repo instead.</p>
<p>Once that&apos;s deployed, you should be able to see the contract on etherscan!</p>
<p><img src="./img/contract.png" alt="etherscan"></p>
<p>To read more about verification, see <a href="https://info.etherscan.com/types-of-contract-verification/#:~:text=Contract%20verification%20allows%20smart%20contract,reading%20the%20contract%20source%20code.">here</a></p>
<h3 class="mume-header" id="mint-a-rentablepets-nft">Mint a RentablePets NFT</h3>

<p>Now, let&apos;s just quickly mint an NFT to list, rent, and unlist in our marketplace!</p>
<pre data-role="codeBlock" data-info="shell" class="language-shell">truffle console --network dashboard
truffle<span class="token punctuation">(</span>dashboard<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">let</span> rp <span class="token operator">=</span> await RentablePets.deployed<span class="token punctuation">(</span><span class="token punctuation">)</span>
undefined
truffle<span class="token punctuation">(</span>dashboard<span class="token punctuation">)</span><span class="token operator">&gt;</span> rp.mint<span class="token punctuation">(</span><span class="token string">&quot;fakeURI&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  tx: <span class="token string">&apos;0xcc2787590995afc740a9f87c1878b4be290477959c7556fd94a4743d768359cd&apos;</span>,
  receipt: <span class="token punctuation">{</span>
    blockHash: <span class="token string">&apos;0x2de64b084ed37dccc19eb5c187da01b2c39ec76d761bd8c5180855585cde58c0&apos;</span>,
    blockNumber: <span class="token number">7551204</span>,
    contractAddress: null,
    cumulativeGasUsed: <span class="token number">578352</span>,
    effectiveGasPrice: <span class="token number">2500000010</span>,
    from: <span class="token string">&apos;0xa31618621805c9215b5ade58eb09dba8f32bbdb8&apos;</span>,
    gasUsed: <span class="token number">117754</span>,
    logs: <span class="token punctuation">[</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">]</span>,
    logsBloom: <span class="token string">&apos;0x00000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000010000000000000000000000040100000000000000000000000008000000000000000000040000000000000200000000000000020000000000000000000800000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000010000000000000000000060000000000000000000000000000000000000000000004000000000000000000000&apos;</span>,
    status: true,
    to: <span class="token string">&apos;0x3af089fee468eb7fcf750e929321b0d7f7845f5c&apos;</span>,
    transactionHash: <span class="token string">&apos;0xcc2787590995afc740a9f87c1878b4be290477959c7556fd94a4743d768359cd&apos;</span>,
    transactionIndex: <span class="token number">12</span>,
    type: <span class="token string">&apos;0x2&apos;</span>,
    rawLogs: <span class="token punctuation">[</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>,
  logs: <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      address: <span class="token string">&apos;0x3Af089fee468eb7fcf750e929321b0D7f7845f5C&apos;</span>,
      blockHash: <span class="token string">&apos;0x2de64b084ed37dccc19eb5c187da01b2c39ec76d761bd8c5180855585cde58c0&apos;</span>,
      blockNumber: <span class="token number">7551204</span>,
      logIndex: <span class="token number">5</span>,
      removed: false,
      transactionHash: <span class="token string">&apos;0xcc2787590995afc740a9f87c1878b4be290477959c7556fd94a4743d768359cd&apos;</span>,
      transactionIndex: <span class="token number">12</span>,
      id: <span class="token string">&apos;log_8554c89f&apos;</span>,
      event: <span class="token string">&apos;Transfer&apos;</span>,
      args: <span class="token punctuation">[</span>Result<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="start-up-a-forked-ganache-instance">Start up a forked Ganache instance</h3>

<p>To list, rent, and unlist this NFT, we&apos;ll need two things:</p>
<ol>
<li>A local ganache instance that includes the deployed contract and the mint transaction</li>
<li>Access to the account that minted the NFT to set approval for the marketplace</li>
</ol>
<p>We can do so as follows:</p>
<p><code>ganache --fork.url https://goerli.infura.io/v3/[API_KEY] --fork.blockNumber [BLOCK_NUMBER_OF_MINT_TRANSACTION] -u [TOKEN_OWNER_ACCOUNT] --port [PORT_NUMBER]</code></p>
<p>Add this instance to your <code>truffle-config</code> networks:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"> goerlidev<span class="token operator">:</span> <span class="token punctuation">{</span>
    host<span class="token operator">:</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span>     <span class="token comment">// Localhost (default: none)</span>
    port<span class="token operator">:</span> <span class="token number">7545</span><span class="token punctuation">,</span>            <span class="token comment">// Standard Ethereum port (default: none)</span>
    network_id<span class="token operator">:</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span>       <span class="token comment">// Any network (default: none)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</pre><h3 class="mume-header" id="write-the-list-script">Write the list script</h3>

<p>Create a <code>list.js</code> file under the <code>scripts</code> directory:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token keyword keyword-const">const</span> <span class="token maybe-class-name">Marketplace</span> <span class="token operator">=</span> artifacts<span class="token punctuation">.</span><span class="token method function property-access">require</span><span class="token punctuation">(</span><span class="token string">&quot;Marketplace&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">TODAY</span> <span class="token operator">=</span> <span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">floor</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">TOMORROW</span> <span class="token operator">=</span> <span class="token constant">TODAY</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">ERC721_ABI</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;inputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;internalType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;to&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;address&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;internalType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uint256&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tokenId&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uint256&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;approve&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;outputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;stateMutability&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nonpayable&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;function&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;inputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;internalType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uint256&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tokenId&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uint256&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ownerOf&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;outputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;internalType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;owner&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;address&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">&quot;stateMutability&quot;</span><span class="token operator">:</span> <span class="token string">&quot;view&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;function&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">NFT_CONTRACT</span> <span class="token operator">=</span> <span class="token string">&quot;NFT_CONTRACT_ADDRESS&quot;</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">TOKEN_ID</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">PRICE</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">START</span> <span class="token operator">=</span> <span class="token constant">TODAY</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">END</span> <span class="token operator">=</span> <span class="token constant">TOMORROW</span><span class="token punctuation">;</span>

<span class="token keyword keyword-const">const</span> <span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-const">const</span> marketplace <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> <span class="token maybe-class-name">Marketplace</span><span class="token punctuation">.</span><span class="token method function property-access">deployed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-const">const</span> listingFee <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword control-flow keyword-await">await</span> marketplace<span class="token punctuation">.</span><span class="token method function property-access">getListingFee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-const">const</span> nftContract <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">web3<span class="token punctuation">.</span>eth<span class="token punctuation">.</span>Contract</span><span class="token punctuation">(</span><span class="token constant">ERC721_ABI</span><span class="token punctuation">,</span> <span class="token constant">NFT_CONTRACT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-const">const</span> owner <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> nftContract<span class="token punctuation">.</span><span class="token property-access">methods</span><span class="token punctuation">.</span><span class="token method function property-access">ownerOf</span><span class="token punctuation">(</span><span class="token constant">TOKEN_ID</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-let">let</span> txn <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> nftContract<span class="token punctuation">.</span><span class="token property-access">methods</span><span class="token punctuation">.</span><span class="token method function property-access">approve</span><span class="token punctuation">(</span>marketplace<span class="token punctuation">.</span><span class="token property-access">address</span><span class="token punctuation">,</span> <span class="token constant">TOKEN_ID</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> owner<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        txn <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> marketplace<span class="token punctuation">.</span><span class="token method function property-access">listNFT</span><span class="token punctuation">(</span>
            <span class="token constant">NFT_CONTRACT</span><span class="token punctuation">,</span> <span class="token constant">TOKEN_ID</span><span class="token punctuation">,</span> <span class="token constant">PRICE</span><span class="token punctuation">,</span> <span class="token constant">START</span><span class="token punctuation">,</span> <span class="token constant">END</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> owner<span class="token punctuation">,</span> value<span class="token operator">:</span> listingFee<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow keyword-catch">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> main<span class="token punctuation">;</span>
</pre><p>Replace [NFT_CONTRACT_ADDRESS] with the contract address of your contract on Goerli. Of note here is how we got the contract functions of the nft contract. Namely, we grabbed the functions we needed (<code>ownerOf</code> and <code>approve</code> from the RentablePets ABI) and passed it into the web3 Contract method:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token keyword keyword-const">const</span> nftContract <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">web3<span class="token punctuation">.</span>eth<span class="token punctuation">.</span>Contract</span><span class="token punctuation">(</span><span class="token constant">ERC721_ABI</span><span class="token punctuation">,</span> <span class="token constant">NFT_CONTRACT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Let&apos;s test it out by calling <code>migrate</code> in the <code>console</code>:</p>
<pre data-role="codeBlock" data-info="shell" class="language-shell">truffle console --network goerlidev
truffle<span class="token punctuation">(</span>goerlidev<span class="token punctuation">)</span><span class="token operator">&gt;</span> migrate

Compiling your contracts<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token operator">&gt;</span> Compiling ./contracts/ERC4907.sol
<span class="token operator">&gt;</span> Compiling ./contracts/IERC4907.sol
<span class="token operator">&gt;</span> Compiling ./contracts/Marketplace.sol
<span class="token operator">&gt;</span> Compiling ./contracts/RentableNft.sol
<span class="token operator">&gt;</span> Compiling @openzeppelin/contracts/interfaces/IERC165.sol
<span class="token operator">&gt;</span> Compiling @openzeppelin/contracts/interfaces/IERC721.sol
<span class="token operator">&gt;</span> Compiling @openzeppelin/contracts/security/ReentrancyGuard.sol
<span class="token operator">&gt;</span> Compiling @openzeppelin/contracts/token/ERC721/ERC721.sol
<span class="token operator">&gt;</span> Compiling @openzeppelin/contracts/token/ERC721/IERC721.sol
<span class="token operator">&gt;</span> Compiling @openzeppelin/contracts/token/ERC721/IERC721Receiver.sol
<span class="token operator">&gt;</span> Compiling @openzeppelin/contracts/token/ERC721/extensions/ERC721URIStorage.sol
<span class="token operator">&gt;</span> Compiling @openzeppelin/contracts/token/ERC721/extensions/IERC721Metadata.sol
<span class="token operator">&gt;</span> Compiling @openzeppelin/contracts/utils/Address.sol
<span class="token operator">&gt;</span> Compiling @openzeppelin/contracts/utils/Context.sol
<span class="token operator">&gt;</span> Compiling @openzeppelin/contracts/utils/Counters.sol
<span class="token operator">&gt;</span> Compiling @openzeppelin/contracts/utils/Strings.sol
<span class="token operator">&gt;</span> Compiling @openzeppelin/contracts/utils/introspection/ERC165.sol
<span class="token operator">&gt;</span> Compiling @openzeppelin/contracts/utils/introspection/IERC165.sol
<span class="token operator">&gt;</span> Compiling @openzeppelin/contracts/utils/structs/EnumerableSet.sol
<span class="token operator">&gt;</span> Artifacts written to /Users/emilylin/dev/rental_marketplace/client/src/contracts
<span class="token operator">&gt;</span> Compiled successfully using:
   - solc: <span class="token number">0.8</span>.14+commit.80d49f37.Emscripten.clang


Migrations dry-run <span class="token punctuation">(</span>simulation<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token operator">&gt;</span> Network name:    <span class="token string">&apos;goerlidev-fork&apos;</span>
<span class="token operator">&gt;</span> Network id:      <span class="token number">5</span>
<span class="token operator">&gt;</span> Block gas limit: <span class="token number">30000000</span> <span class="token punctuation">(</span>0x1c9c380<span class="token punctuation">)</span>


1_deploy_contract.js
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

   Deploying <span class="token string">&apos;Marketplace&apos;</span>
   -----------------------
   <span class="token operator">&gt;</span> block number:        <span class="token number">7551207</span>
   <span class="token operator">&gt;</span> block timestamp:     <span class="token number">1662611960</span>
   <span class="token operator">&gt;</span> account:             0x766160261b23502C82473Eb5749f47089909dCaa
   <span class="token operator">&gt;</span> balance:             <span class="token number">999.993796389977667004</span>
   <span class="token operator">&gt;</span> gas used:            <span class="token number">2481444</span> <span class="token punctuation">(</span>0x25dd24<span class="token punctuation">)</span>
   <span class="token operator">&gt;</span> gas price:           <span class="token number">2.500000009</span> gwei
   <span class="token operator">&gt;</span> value sent:          <span class="token number">0</span> ETH
   <span class="token operator">&gt;</span> total cost:          <span class="token number">0.006203610022332996</span> ETH


   Deploying <span class="token string">&apos;RentableNft&apos;</span>
   -----------------------
   <span class="token operator">&gt;</span> block number:        <span class="token number">7551208</span>
   <span class="token operator">&gt;</span> block timestamp:     <span class="token number">1662611961</span>
   <span class="token operator">&gt;</span> account:             0x766160261b23502C82473Eb5749f47089909dCaa
   <span class="token operator">&gt;</span> balance:             <span class="token number">999.986735529952247908</span>
   <span class="token operator">&gt;</span> gas used:            <span class="token number">2824344</span> <span class="token punctuation">(</span>0x2b1898<span class="token punctuation">)</span>
   <span class="token operator">&gt;</span> gas price:           <span class="token number">2.500000009</span> gwei
   <span class="token operator">&gt;</span> value sent:          <span class="token number">0</span> ETH
   <span class="token operator">&gt;</span> total cost:          <span class="token number">0.007060860025419096</span> ETH

   -------------------------------------
   <span class="token operator">&gt;</span> Total cost:     <span class="token number">0.013264470047752092</span> ETH

Summary
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token operator">&gt;</span> Total deployments:   <span class="token number">2</span>
<span class="token operator">&gt;</span> Final cost:          <span class="token number">0.013264470047752092</span> ETH




Starting migrations<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">&gt;</span> Network name:    <span class="token string">&apos;goerlidev&apos;</span>
<span class="token operator">&gt;</span> Network id:      <span class="token number">5</span>
<span class="token operator">&gt;</span> Block gas limit: <span class="token number">30000000</span> <span class="token punctuation">(</span>0x1c9c380<span class="token punctuation">)</span>


1_deploy_contract.js
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

   Deploying <span class="token string">&apos;Marketplace&apos;</span>
   -----------------------
   <span class="token operator">&gt;</span> transaction hash:    0x903c8b43645caad6cfc7a85946f6166fdd4150d936ed8d75fa0d1db9ba67315e
   <span class="token operator">&gt;</span> Blocks: <span class="token number">0</span>            Seconds: <span class="token number">0</span>
   <span class="token operator">&gt;</span> contract address:    0x8f7D9a7EFFAD4d0c93CFdbB8b8A7A0BC1A600baf
   <span class="token operator">&gt;</span> block number:        <span class="token number">7551206</span>
   <span class="token operator">&gt;</span> block timestamp:     <span class="token number">1662611961</span>
   <span class="token operator">&gt;</span> account:             0x766160261b23502C82473Eb5749f47089909dCaa
   <span class="token operator">&gt;</span> balance:             <span class="token number">999.993796389977667004</span>
   <span class="token operator">&gt;</span> gas used:            <span class="token number">2481444</span> <span class="token punctuation">(</span>0x25dd24<span class="token punctuation">)</span>
   <span class="token operator">&gt;</span> gas price:           <span class="token number">2.500000009</span> gwei
   <span class="token operator">&gt;</span> value sent:          <span class="token number">0</span> ETH
   <span class="token operator">&gt;</span> total cost:          <span class="token number">0.006203610022332996</span> ETH


   Deploying <span class="token string">&apos;RentableNft&apos;</span>
   -----------------------
   <span class="token operator">&gt;</span> transaction hash:    0x8ebabb1b0d376cbd8dc7d19743bbef4bc4bd1485743f3857b7c2f63c67b39f19
   <span class="token operator">&gt;</span> Blocks: <span class="token number">0</span>            Seconds: <span class="token number">0</span>
   <span class="token operator">&gt;</span> contract address:    0xEdBDba2B0Fc091DC6def14ed727e6Da48a546FA7
   <span class="token operator">&gt;</span> block number:        <span class="token number">7551207</span>
   <span class="token operator">&gt;</span> block timestamp:     <span class="token number">1662611961</span>
   <span class="token operator">&gt;</span> account:             0x766160261b23502C82473Eb5749f47089909dCaa
   <span class="token operator">&gt;</span> balance:             <span class="token number">999.986735529952247908</span>
   <span class="token operator">&gt;</span> gas used:            <span class="token number">2824344</span> <span class="token punctuation">(</span>0x2b1898<span class="token punctuation">)</span>
   <span class="token operator">&gt;</span> gas price:           <span class="token number">2.500000009</span> gwei
   <span class="token operator">&gt;</span> value sent:          <span class="token number">0</span> ETH
   <span class="token operator">&gt;</span> total cost:          <span class="token number">0.007060860025419096</span> ETH

   <span class="token operator">&gt;</span> Saving artifacts
   -------------------------------------
   <span class="token operator">&gt;</span> Total cost:     <span class="token number">0.013264470047752092</span> ETH

Summary
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token operator">&gt;</span> Total deployments:   <span class="token number">4</span>
<span class="token operator">&gt;</span> Final cost:          <span class="token number">0.026528940095504184</span> ETH


truffle<span class="token punctuation">(</span>goerlidev<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">exec</span> scripts/list.js
Using network <span class="token string">&apos;goerlidev&apos;</span><span class="token builtin class-name">.</span>

<span class="token punctuation">{</span>
  transactionHash: <span class="token string">&apos;0x0a7744320828e574cb6f359fc48b8b12bb72c96aee0adcf8117615cf04ada6d1&apos;</span>,
  transactionIndex: <span class="token number">0</span>,
  blockNumber: <span class="token number">7551208</span>,
  blockHash: <span class="token string">&apos;0x155d4646401b1d0b6cb3816c7cf2f2f117a9d628d3be18d95afa306c910b6665&apos;</span>,
  from: <span class="token string">&apos;0xa31618621805c9215b5ade58eb09dba8f32bbdb8&apos;</span>,
  to: <span class="token string">&apos;0x3af089fee468eb7fcf750e929321b0d7f7845f5c&apos;</span>,
  cumulativeGasUsed: <span class="token number">49236</span>,
  gasUsed: <span class="token number">49236</span>,
  contractAddress: null,
  logsBloom: <span class="token string">&apos;0x00000000000000200000000000000000000000000000000000000000008000000000000000000000000000000000000000010000000000000000000000240100000020100000000000000000000000000000000000040000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000040000010000000000000000000000000000000000000004000000000000000000000&apos;</span>,
  status: true,
  effectiveGasPrice: <span class="token number">2500000009</span>,
  type: <span class="token string">&apos;0x2&apos;</span>,
  events: <span class="token punctuation">{</span>
    <span class="token string">&apos;0&apos;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      address: <span class="token string">&apos;0x3Af089fee468eb7fcf750e929321b0D7f7845f5C&apos;</span>,
      blockHash: <span class="token string">&apos;0x155d4646401b1d0b6cb3816c7cf2f2f117a9d628d3be18d95afa306c910b6665&apos;</span>,
      blockNumber: <span class="token number">7551208</span>,
      logIndex: <span class="token number">0</span>,
      removed: false,
      transactionHash: <span class="token string">&apos;0x0a7744320828e574cb6f359fc48b8b12bb72c96aee0adcf8117615cf04ada6d1&apos;</span>,
      transactionIndex: <span class="token number">0</span>,
      id: <span class="token string">&apos;log_ddded61e&apos;</span>,
      returnValues: Result <span class="token punctuation">{</span><span class="token punctuation">}</span>,
      event: undefined,
      signature: null,
      raw: <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
  tx: <span class="token string">&apos;0xd0681047e8873ca3265199ac87ebe2fd3c27063ed35850eb31906896670c636a&apos;</span>,
  receipt: <span class="token punctuation">{</span>
    transactionHash: <span class="token string">&apos;0xd0681047e8873ca3265199ac87ebe2fd3c27063ed35850eb31906896670c636a&apos;</span>,
    transactionIndex: <span class="token number">0</span>,
    blockNumber: <span class="token number">7551209</span>,
    blockHash: <span class="token string">&apos;0xb9908ab4e78e4393c1b3b6c41601b4b2575a6bb57ecfc69b0243476686292e64&apos;</span>,
    from: <span class="token string">&apos;0xa31618621805c9215b5ade58eb09dba8f32bbdb8&apos;</span>,
    to: <span class="token string">&apos;0x8f7d9a7effad4d0c93cfdbb8b8a7a0bc1a600baf&apos;</span>,
    cumulativeGasUsed: <span class="token number">348370</span>,
    gasUsed: <span class="token number">348370</span>,
    contractAddress: null,
    logs: <span class="token punctuation">[</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">]</span>,
    logsBloom: <span class="token string">&apos;0x00000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000080004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&apos;</span>,
    status: true,
    effectiveGasPrice: <span class="token number">2500000008</span>,
    type: <span class="token string">&apos;0x2&apos;</span>,
    rawLogs: <span class="token punctuation">[</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>,
  logs: <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      address: <span class="token string">&apos;0x8f7D9a7EFFAD4d0c93CFdbB8b8A7A0BC1A600baf&apos;</span>,
      blockHash: <span class="token string">&apos;0xb9908ab4e78e4393c1b3b6c41601b4b2575a6bb57ecfc69b0243476686292e64&apos;</span>,
      blockNumber: <span class="token number">7551209</span>,
      logIndex: <span class="token number">0</span>,
      removed: false,
      transactionHash: <span class="token string">&apos;0xd0681047e8873ca3265199ac87ebe2fd3c27063ed35850eb31906896670c636a&apos;</span>,
      transactionIndex: <span class="token number">0</span>,
      id: <span class="token string">&apos;log_1f383ff1&apos;</span>,
      event: <span class="token string">&apos;NFTListed&apos;</span>,
      args: <span class="token punctuation">[</span>Result<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
truffle<span class="token punctuation">(</span>goerlidev<span class="token punctuation">)</span><span class="token operator">&gt;</span> 
</pre><p>We&apos;ll be following similar patterns in the following scripts.</p>
<h3 class="mume-header" id="write-rentjs">Write rent.js</h3>

<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token keyword keyword-const">const</span> <span class="token maybe-class-name">Marketplace</span> <span class="token operator">=</span> artifacts<span class="token punctuation">.</span><span class="token method function property-access">require</span><span class="token punctuation">(</span><span class="token string">&quot;Marketplace&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">TODAY</span> <span class="token operator">=</span> <span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">floor</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">TOMORROW</span> <span class="token operator">=</span> <span class="token constant">TODAY</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">NFT_CONTRACT</span> <span class="token operator">=</span> <span class="token string">&quot;NFT_CONTRACT&quot;</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">TOKEN_ID</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">EXPIRES</span> <span class="token operator">=</span> <span class="token constant">TOMORROW</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">PRICE</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword keyword-const">const</span> <span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-const">const</span> marketplace <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> <span class="token maybe-class-name">Marketplace</span><span class="token punctuation">.</span><span class="token method function property-access">deployed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-let">let</span> value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">EXPIRES</span> <span class="token operator">-</span> <span class="token constant">TODAY</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">60</span><span class="token operator">/</span><span class="token number">60</span><span class="token operator">/</span><span class="token number">24</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">PRICE</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-let">let</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword control-flow keyword-await">await</span> web3<span class="token punctuation">.</span><span class="token property-access">eth</span><span class="token punctuation">.</span><span class="token method function property-access">getAccounts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        txn <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> marketplace<span class="token punctuation">.</span><span class="token method function property-access">rentNFT</span><span class="token punctuation">(</span><span class="token constant">NFT_CONTRACT</span><span class="token punctuation">,</span> <span class="token constant">TOKEN_ID</span><span class="token punctuation">,</span> <span class="token constant">EXPIRES</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> user<span class="token punctuation">,</span> value<span class="token operator">:</span> value<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow keyword-catch">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> main<span class="token punctuation">;</span>
</pre><pre data-role="codeBlock" data-info="shell" class="language-shell">truffle<span class="token punctuation">(</span>goerlidev<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">exec</span> scripts/rent.js
Using network <span class="token string">&apos;goerlidev&apos;</span><span class="token builtin class-name">.</span>

<span class="token punctuation">{</span>
  tx: <span class="token string">&apos;0xc8b9ecaeccdc502ca2c334e2ecafdea17409c631622c8e0c9b26e42ce59f8325&apos;</span>,
  receipt: <span class="token punctuation">{</span>
    transactionHash: <span class="token string">&apos;0xc8b9ecaeccdc502ca2c334e2ecafdea17409c631622c8e0c9b26e42ce59f8325&apos;</span>,
    transactionIndex: <span class="token number">0</span>,
    blockNumber: <span class="token number">7551210</span>,
    blockHash: <span class="token string">&apos;0x3606594dbcec10924a73112a481fd368257b2a949b9fc1f3cddbbd786ab8f852&apos;</span>,
    from: <span class="token string">&apos;0x766160261b23502c82473eb5749f47089909dcaa&apos;</span>,
    to: <span class="token string">&apos;0x8f7d9a7effad4d0c93cfdbb8b8a7a0bc1a600baf&apos;</span>,
    cumulativeGasUsed: <span class="token number">130387</span>,
    gasUsed: <span class="token number">130387</span>,
    contractAddress: null,
    logs: <span class="token punctuation">[</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">]</span>,
    logsBloom: <span class="token string">&apos;0x00000000000000000000004001000000000000000000000000000000008000001000000000000000000000000008000000010000000000000000000020040000000000000000000000000000000000000000000000040000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040800000000000000000000000000000000000020000000000000020000000000000000000100000000000000000000000000000000000000000000000000000000000040000000000000800000080000000000000000000000000000000000000000000000&apos;</span>,
    status: true,
    effectiveGasPrice: <span class="token number">2500000008</span>,
    type: <span class="token string">&apos;0x2&apos;</span>,
    rawLogs: <span class="token punctuation">[</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>, <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>,
  logs: <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      address: <span class="token string">&apos;0x8f7D9a7EFFAD4d0c93CFdbB8b8A7A0BC1A600baf&apos;</span>,
      blockHash: <span class="token string">&apos;0x3606594dbcec10924a73112a481fd368257b2a949b9fc1f3cddbbd786ab8f852&apos;</span>,
      blockNumber: <span class="token number">7551210</span>,
      logIndex: <span class="token number">1</span>,
      removed: false,
      transactionHash: <span class="token string">&apos;0xc8b9ecaeccdc502ca2c334e2ecafdea17409c631622c8e0c9b26e42ce59f8325&apos;</span>,
      transactionIndex: <span class="token number">0</span>,
      id: <span class="token string">&apos;log_0dd47305&apos;</span>,
      event: <span class="token string">&apos;NFTRented&apos;</span>,
      args: <span class="token punctuation">[</span>Result<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
truffle<span class="token punctuation">(</span>goerlidev<span class="token punctuation">)</span><span class="token operator">&gt;</span> 
</pre><h3 class="mume-header" id="write-unlistjs">Write <code>unlist.js</code></h3>

<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token keyword keyword-const">const</span> <span class="token maybe-class-name">Marketplace</span> <span class="token operator">=</span> artifacts<span class="token punctuation">.</span><span class="token method function property-access">require</span><span class="token punctuation">(</span><span class="token string">&quot;Marketplace&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">NFT_CONTRACT</span> <span class="token operator">=</span> <span class="token string">&quot;NFT_CONTRACT&quot;</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">TOKEN_ID</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">PRICE</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">ERC721_ABI</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;inputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token string">&quot;internalType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uint256&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tokenId&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uint256&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;userExpires&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;outputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token string">&quot;internalType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uint256&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uint256&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">&quot;stateMutability&quot;</span><span class="token operator">:</span> <span class="token string">&quot;view&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;constant&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;inputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;internalType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uint256&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tokenId&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uint256&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ownerOf&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;outputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;internalType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;owner&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;address&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">&quot;stateMutability&quot;</span><span class="token operator">:</span> <span class="token string">&quot;view&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;function&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword keyword-const">const</span> <span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-const">const</span> marketplace <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> <span class="token maybe-class-name">Marketplace</span><span class="token punctuation">.</span><span class="token method function property-access">deployed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-const">const</span> nftContract <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">web3<span class="token punctuation">.</span>eth<span class="token punctuation">.</span>Contract</span><span class="token punctuation">(</span><span class="token constant">ERC721_ABI</span><span class="token punctuation">,</span> <span class="token constant">NFT_CONTRACT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-const">const</span> expires <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> nftContract<span class="token punctuation">.</span><span class="token property-access">methods</span><span class="token punctuation">.</span><span class="token method function property-access">userExpires</span><span class="token punctuation">(</span><span class="token constant">TOKEN_ID</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-let">let</span> value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>expires <span class="token operator">-</span> <span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">60</span><span class="token operator">/</span><span class="token number">60</span><span class="token operator">/</span><span class="token number">24</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">PRICE</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-const">const</span> owner <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> nftContract<span class="token punctuation">.</span><span class="token property-access">methods</span><span class="token punctuation">.</span><span class="token method function property-access">ownerOf</span><span class="token punctuation">(</span><span class="token constant">TOKEN_ID</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-let">let</span> options <span class="token operator">=</span> value <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> owner<span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> owner<span class="token punctuation">,</span> value<span class="token operator">:</span> value<span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-let">let</span> txn <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> marketplace<span class="token punctuation">.</span><span class="token method function property-access">unlistNFT</span><span class="token punctuation">(</span><span class="token constant">NFT_CONTRACT</span><span class="token punctuation">,</span> <span class="token constant">TOKEN_ID</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow keyword-catch">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
  
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> main<span class="token punctuation">;</span>
</pre><p>You might not have enough ETH in the owner wallet to cover the refund. If so, jump to the bonus section to write a script to fund wallets with ETH on your ganache instance!</p>
<pre data-role="codeBlock" data-info="shell" class="language-shell">truffle<span class="token punctuation">(</span>goerlidev<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">exec</span> scripts/unlist.js
Using network <span class="token string">&apos;goerlidev&apos;</span><span class="token builtin class-name">.</span>

<span class="token punctuation">{</span>
  tx: <span class="token string">&apos;0xe88e20e9543a5053c3e27d69714f1216e0677c202d911e06f2ca644e93b17742&apos;</span>,
  receipt: <span class="token punctuation">{</span>
    transactionHash: <span class="token string">&apos;0xe88e20e9543a5053c3e27d69714f1216e0677c202d911e06f2ca644e93b17742&apos;</span>,
    transactionIndex: <span class="token number">0</span>,
    blockNumber: <span class="token number">7551212</span>,
    blockHash: <span class="token string">&apos;0xfd3ed03ed838e004494293336b35eb69e56df75efedd8a6b43ca70e94dc9cc24&apos;</span>,
    from: <span class="token string">&apos;0xa31618621805c9215b5ade58eb09dba8f32bbdb8&apos;</span>,
    to: <span class="token string">&apos;0x8f7d9a7effad4d0c93cfdbb8b8a7a0bc1a600baf&apos;</span>,
    cumulativeGasUsed: <span class="token number">110370</span>,
    gasUsed: <span class="token number">110370</span>,
    contractAddress: null,
    logs: <span class="token punctuation">[</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">]</span>,
    logsBloom: <span class="token string">&apos;0x00000000000000000000004001000000000000000000000000000000008000000000000000000000000000000000000000010000000000000000000000040000000800000000000000000000000000000000000000040000000000000200000000000000020080000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000040800000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000064000000000000800000000000000000000000000000000000000000000000000000&apos;</span>,
    status: true,
    effectiveGasPrice: <span class="token number">2500000007</span>,
    type: <span class="token string">&apos;0x2&apos;</span>,
    rawLogs: <span class="token punctuation">[</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>, <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>,
  logs: <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      address: <span class="token string">&apos;0x8f7D9a7EFFAD4d0c93CFdbB8b8A7A0BC1A600baf&apos;</span>,
      blockHash: <span class="token string">&apos;0xfd3ed03ed838e004494293336b35eb69e56df75efedd8a6b43ca70e94dc9cc24&apos;</span>,
      blockNumber: <span class="token number">7551212</span>,
      logIndex: <span class="token number">1</span>,
      removed: false,
      transactionHash: <span class="token string">&apos;0xe88e20e9543a5053c3e27d69714f1216e0677c202d911e06f2ca644e93b17742&apos;</span>,
      transactionIndex: <span class="token number">0</span>,
      id: <span class="token string">&apos;log_e724900c&apos;</span>,
      event: <span class="token string">&apos;NFTUnlisted&apos;</span>,
      args: <span class="token punctuation">[</span>Result<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="write-runjs">Write run.js</h3>

<p>Finally, for faster testing, let&apos;s just write a script that will run through the whole process from minting to unlisting:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token keyword keyword-const">const</span> <span class="token maybe-class-name">Marketplace</span> <span class="token operator">=</span> artifacts<span class="token punctuation">.</span><span class="token method function property-access">require</span><span class="token punctuation">(</span><span class="token string">&quot;Marketplace&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">NFT_CONTRACT</span> <span class="token operator">=</span> <span class="token string">&quot;NFT_CONTRACT&quot;</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">TOKEN_ID</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">PRICE</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> <span class="token constant">ERC721_ABI</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;inputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token string">&quot;internalType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uint256&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tokenId&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uint256&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;userExpires&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;outputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token string">&quot;internalType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uint256&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uint256&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">&quot;stateMutability&quot;</span><span class="token operator">:</span> <span class="token string">&quot;view&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;constant&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;inputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;internalType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uint256&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tokenId&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uint256&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ownerOf&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;outputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;internalType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;owner&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;address&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">&quot;stateMutability&quot;</span><span class="token operator">:</span> <span class="token string">&quot;view&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;function&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword keyword-const">const</span> <span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-const">const</span> marketplace <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> <span class="token maybe-class-name">Marketplace</span><span class="token punctuation">.</span><span class="token method function property-access">deployed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-const">const</span> nftContract <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">web3<span class="token punctuation">.</span>eth<span class="token punctuation">.</span>Contract</span><span class="token punctuation">(</span><span class="token constant">ERC721_ABI</span><span class="token punctuation">,</span> <span class="token constant">NFT_CONTRACT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-const">const</span> expires <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> nftContract<span class="token punctuation">.</span><span class="token property-access">methods</span><span class="token punctuation">.</span><span class="token method function property-access">userExpires</span><span class="token punctuation">(</span><span class="token constant">TOKEN_ID</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-let">let</span> value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>expires <span class="token operator">-</span> <span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">60</span><span class="token operator">/</span><span class="token number">60</span><span class="token operator">/</span><span class="token number">24</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">PRICE</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-const">const</span> owner <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> nftContract<span class="token punctuation">.</span><span class="token property-access">methods</span><span class="token punctuation">.</span><span class="token method function property-access">ownerOf</span><span class="token punctuation">(</span><span class="token constant">TOKEN_ID</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-let">let</span> options <span class="token operator">=</span> value <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> owner<span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token keyword module keyword-from">from</span><span class="token operator">:</span> owner<span class="token punctuation">,</span> value<span class="token operator">:</span> value<span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-let">let</span> txn <span class="token operator">=</span> <span class="token keyword control-flow keyword-await">await</span> marketplace<span class="token punctuation">.</span><span class="token method function property-access">unlistNFT</span><span class="token punctuation">(</span><span class="token constant">NFT_CONTRACT</span><span class="token punctuation">,</span> <span class="token constant">TOKEN_ID</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow keyword-catch">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> main<span class="token punctuation">;</span>
</pre><h2 class="mume-header" id="bonus-write-a-script-to-fund-your-test-wallets">BONUS: Write a script to fund your test wallets</h2>

<p>Scripts allow you to execute common tasks quickly. One thing you might want to do is fund test wallets! Here&apos;s a quick utility script to do so. Create a file <code>load.js</code>:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token keyword keyword-const">const</span> <span class="token constant">ACCOUNT</span> <span class="token operator">=</span> <span class="token string">&quot;[ACCOUNT_NUMBER]&quot;</span><span class="token punctuation">;</span>

<span class="token keyword keyword-const">const</span> <span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow keyword-await">await</span> web3<span class="token punctuation">.</span><span class="token property-access">currentProvider</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            method<span class="token operator">:</span><span class="token string">&quot;evm_setAccountBalance&quot;</span><span class="token punctuation">,</span>
            params<span class="token operator">:</span><span class="token punctuation">[</span><span class="token constant">ACCOUNT</span><span class="token punctuation">,</span> <span class="token string">&quot;0x3635c9adc5dea00000&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword keyword-function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword control-flow keyword-await">await</span> web3<span class="token punctuation">.</span><span class="token property-access">eth</span><span class="token punctuation">.</span><span class="token method function property-access">getBalance</span><span class="token punctuation">(</span><span class="token constant">ACCOUNT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow keyword-catch">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
  
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> main<span class="token punctuation">;</span>
</pre><p>In this file, <code>0x3635c9adc5dea00000</code> is 1000 ETH in hexadecimal. Now, fund your wallet as follows:</p>
<pre data-role="codeBlock" data-info="shell" class="language-shell">truffle<span class="token punctuation">(</span>goerlidev<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token builtin class-name">exec</span> scripts/load.js
</pre>

      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>